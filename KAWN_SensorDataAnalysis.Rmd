---
title: 'KAWN RAPID: Sensor Data Analysis'
author: "Michelle Catherine Kelly"
date: "22 April 2018"
output:
  html_document:
    theme: yeti
    df_print: paged
    toc: yes
    number_sections: true
---

```{r setup, echo = FALSE, warning=FALSE, error=FALSE, message=FALSE}
### Global options ###
knitr::opts_chunk$set(fig.height = 8, 
                      fig.width = 10, 
                      cache=TRUE) # enable caching globally

### General packages ###
library(XML)
library(lubridate)
library(ggplot2)
library(gridExtra)
library(grid)
library(dplyr)
library(magrittr)
library(zoo)
library(wesanderson) # pallets
library(chron)
library(data.table)

### USGS loading ###
library(dataRetrieval)

### NEON loading ###
# library(devtools)
# install_github("NEONScience/NEON-utilities/neonUtilities", dependencies = TRUE)
library(neonUtilities)

### Stream metabolism ###
# install.packages("streamMetabolizer", dependencies = TRUE, repos = c("https://owi.usgs.gov/R", "https://cran.rstudio.com"))
library(streamMetabolizer)
library(rstan)
# install.packages("installr")
# library("installr")
# install.Rtools()

# check if Rtools is installed properly, output should be 4
# install.packages("Rcpp")
# library(Rcpp)
# Rcpp::evalCpp("2+2")
```

***  

# Overview

This is a **working document** for analyzing sensor data from the NSF RAPID Kansas River Nitrogen Cycling Project

***  

# Data Import  

This section contains all data loading and cleanup chunks  

Data pull = data is taken from an online host (USGS, NEON)
Data load = data is taken from local file

## Nitratax Data  

### Data pull and cleanup  

**Nitratax_XMLtoCSV:** Function to convert raw-from-sensor .xml file to more convenient .csv file  
```{r Nitratax_XMLtoCSV, include=FALSE}
# Function name:
      # Nitratax_XMLtoCSV
# Function description:
      # Convert output format from Nitratax sensor (.xml) into .csv file
# Input variable definitions:
      # filename = .xml file to be converted, character  string
      # sensor = character string of sensor name, will be outputted in .csv file name
      # deployDate = start date of sensor operation, YYYY-MM-DD character string
# Outputs:
      # .csv file titled "KansasR_Nitratax_<sensor>.csv"

Nitratax_XMLtoCSV <- function(filename, sensor, deployDate){
  
  xmlData <- XML::xmlParse(file = filename)
  xmlData <- XML::xmlToDataFrame(xmlData, homogeneous = F, stringsAsFactors = F)
  xmlData <- xmlData[-(1:6),] # taking out text at top of dataframe
  
  for (count in 1:length(xmlData)){
    names(xmlData)[count] <- as.character(xmlData[1,count])
  }
  
  xmlData <- xmlData[-1,] # taking out character rows
  xmlData <- xmlData[,-1] # taking out first blank column
  
  xmlData$`  TIME  ` <- lubridate::as_datetime(xmlData$`  TIME  `, 
                                               tz = "America/Chicago", 
                                               format = "%m/%d/%Y %H:%M:%S")
  xmlData$`  NITRATE CONC.  ` <- as.numeric(xmlData$`  NITRATE CONC.  `)
  xmlData$`  ER  ` <- as.numeric(xmlData$`  ER  `)
  xmlData$`  EM  ` <- as.numeric(xmlData$`  EM  `)
  
  xml_trunkated <- xmlData[xmlData$`  TIME  `>ymd(deployDate),] # subset only data from deploy onwards
  
  xml_trunkated <- data.frame(xml_trunkated$`  TIME  `, 
                              xml_trunkated$`  NITRATE CONC.  `)
  names(xml_trunkated) <- c("Date and time", "Nitrate plus nitrite as mg-N/L")
  CSV_filename <- paste("KansasR_Nitratax_", 
                        sensor, 
                        ".csv", sep = "")
  
  write.table(xml_trunkated, 
              file = CSV_filename,
              sep = ",", row.names = FALSE)
  return(xml_trunkated)
  
}
```

Import of Nitratax data into R environment, cleanup
```{r NitrataxLoadingCleanup, include=FALSE}
# Variable descriptions:    
      # loadfromCSV = logical vector, if TRUE data will be loaded from .csv files
                                    # if FALSE data will be converted from .xml to .csv
                                    # (computationally much faster to load from .csv)
      # bowersock_N = Nitratax sensor located at the bowersock dam upstream of waste release
      # eric_N = Nitratax sensor located at the waste release point
      # steve_N = Nitratax sensor located about ~5 miles downstream of bowersock

loadfromCSV <- TRUE 

if (loadfromCSV == TRUE){
  
  bowersock_N <- read.csv(file = "KansasR_Nitratax_Bowersock.csv", 
                          header = TRUE,
                          colClasses = c("POSIXct", "numeric"))
  eric_N <- read.csv(file = "KansasR_Nitratax_Eric.csv", 
                     header = TRUE,
                     colClasses = c("POSIXct", "numeric"))
  steve_N <- read.csv(file = "KansasR_Nitratax_Steve.csv", 
                      header = TRUE,
                      colClasses = c("POSIXct", "numeric"))
  
  names(bowersock_N) <- c("Date and time", "Nitrate plus nitrite as mg-N/L")
  names(eric_N) <- c("Date and time", "Nitrate plus nitrite as mg-N/L")
  names(steve_N) <- c("Date and time", "Nitrate plus nitrite as mg-N/L")
  
  cat("data loaded from .csv file")
  
}
if (loadfromCSV == FALSE) {
  
  bowersock_N <- Nitratax_XMLtoCSV(filename = "NITRATAX_Bowersock_Pulled04-13-2018.xml", 
                                   sensor = "Bowersock", 
                                   deployDate = "2018-01-13")
  eric_N <- Nitratax_XMLtoCSV(filename = "NITRATAX_Eric_Pulled04-13-2018.xml", 
                              sensor = "Eric", 
                              deployDate = "2018-02-19")
  steve_N <- Nitratax_XMLtoCSV(filename = "NITRATAX_Steve_Pulled04-20-2018.xml", 
                               sensor = "Steve", 
                               deployDate = "2018-01-31")
  
  cat("data loaded from .xml file")
  
  # Eric sensor was buried under sediment from 05-Mar to 15-Mar, setting these measurements to NA
  dateSedimentStartEric <- ymd_hms("2018-03-05 11:00:00", tz = "America/Chicago")
  dateSedimentEndEric <- ymd_hms("2018-03-15 11:00:00", tz = "America/Chicago")
  eric_N$`Nitrate plus nitrite as mg-N/L`[eric_N$`Date and time` >= dateSedimentStartEric 
                                          & 
                                            eric_N$`Date and time` <= dateSedimentEndEric] <- NA

  # Setting Steve to NA for all measurements of "0", due to sediment issues
  steve_N$`Nitrate plus nitrite as mg-N/L`[steve_N$`Nitrate plus nitrite as mg-N/L` <= 0] <- NA

  # Setting Steve to NA during time period of sediment burial
  dateSedimentStartSteve <- lubridate::as_datetime("2018-03-12 15:00:00")
  dateSedimentEndSteve <- lubridate::as_datetime("2018-03-27 11:30:00")
  steve_N$`Nitrate plus nitrite as mg-N/L`[steve_N$`Date and time`>=dateSedimentStartSteve 
                                           & 
                                             steve_N$`Date and time`<=dateSedimentEndSteve] <- NA
}
```

***  

## miniDOT Data  

Loading miniDOT sensor files: dissolved oxygen and temperature data  
```{r DOloadingCleanup, include=FALSE}
steve_DO <- read.table(file = "miniDOT_Steve_Pulled04-20-2018.txt", header = TRUE,
                       sep = ",", skip = 8, stringsAsFactors = FALSE,
                       colClasses = c("numeric", "POSIXct", "POSIXct", "numeric",
                                      "numeric", "numeric", "numeric", "numeric"),
                       col.names = c("unixTimestamp", "time_UTC", "time_CST", "battery_V",
                                     "temp_C", "DO_mgL", "DO_sat", "Q"))

eric_DO <- read.table(file = "miniDOT_Eric_Pulled05-07-2018.txt", header = TRUE,
                       sep = ",", skip = 8, stringsAsFactors = FALSE,
                       colClasses = c("numeric", "POSIXct", "POSIXct", "numeric",
                                      "numeric", "numeric", "numeric", "numeric"),
                       col.names = c("unixTimestamp", "time_UTC", "time_CST", "battery_V",
                                     "temp_C", "DO_mgL", "DO_sat", "Q"))

# Eric DO cleanup
# 19 - 25 Feb
eric_DO$DO_mgL[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-02-19 10:38:00", tz = "America/Chicago"),
                   ymd_hms("2018-02-25 01:28:00", tz = "America/Chicago"))] <- NA
eric_DO$temp_C[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-02-19 10:38:00", tz = "America/Chicago"),
                   ymd_hms("2018-02-25 01:28:00", tz = "America/Chicago"))] <- NA
# 5 - 15 Mar
eric_DO$DO_mgL[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-03-05 09:58:00", tz = "America/Chicago"),
                   ymd_hms("2018-03-15 11:08:00", tz = "America/Chicago"))] <- NA
eric_DO$temp_C[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-03-05 09:58:00", tz = "America/Chicago"),
                   ymd_hms("2018-03-15 11:08:00", tz = "America/Chicago"))] <- NA
# 28 Mar
eric_DO$DO_mgL[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-03-28 04:25:00", tz = "America/Chicago"),
                   ymd_hms("2018-03-28 21:25:00", tz = "America/Chicago"))] <- NA
eric_DO$temp_C[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-03-28 04:25:00", tz = "America/Chicago"),
                   ymd_hms("2018-03-28 21:25:00", tz = "America/Chicago"))] <- NA
# 30 Mar - 5 Apr
eric_DO$DO_mgL[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-03-30 23:35:00", tz = "America/Chicago"),
                   ymd_hms("2018-04-05 12:00:00", tz = "America/Chicago"))] <- NA
eric_DO$temp_C[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-03-30 23:35:00", tz = "America/Chicago"),
                   ymd_hms("2018-04-05 12:00:00", tz = "America/Chicago"))] <- NA
# 14-18 Apr
eric_DO$DO_mgL[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-04-14 12:23:00", tz = "America/Chicago"),
                   ymd_hms("2018-04-18 00:00:00", tz = "America/Chicago"))] <- NA
eric_DO$temp_C[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-04-14 12:23:00", tz = "America/Chicago"),
                   ymd_hms("2018-04-18 00:00:00", tz = "America/Chicago"))] <- NA
# 25-30 Apr
eric_DO$DO_mgL[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-04-25 19:33:00", tz = "America/Chicago"),
                   ymd_hms("2018-04-30 15:53:00", tz = "America/Chicago"))] <- NA
eric_DO$temp_C[eric_DO$time_CST 
               %between% 
                 c(ymd_hms("2018-04-25 19:33:00", tz = "America/Chicago"),
                   ymd_hms("2018-04-30 15:53:00", tz = "America/Chicago"))] <- NA

# Steve
# 30 Jan
steve_DO$DO_mgL[steve_DO$time_CST 
                %between% 
                c(ymd_hms("2018-01-30 15:24:00", tz = "America/Chicago"),
                  ymd_hms("2018-01-30 16:54:00", tz = "America/Chicago"))] <- NA
steve_DO$temp_C[steve_DO$time_CST 
                %between% 
                c(ymd_hms("2018-01-30 15:24:00", tz = "America/Chicago"),
                  ymd_hms("2018-01-30 16:54:00", tz = "America/Chicago"))] <- NA
# 9-12 Mar
steve_DO$DO_mgL[steve_DO$time_CST 
                %between% 
                c(ymd_hms("2018-03-09 17:17:00", tz = "America/Chicago"),
                  ymd_hms("2018-03-12 10:47:00", tz = "America/Chicago"))] <- NA
steve_DO$temp_C[steve_DO$time_CST 
                %between% 
                c(ymd_hms("2018-03-09 17:17:00", tz = "America/Chicago"),
                  ymd_hms("2018-03-12 10:47:00", tz = "America/Chicago"))] <- NA
# 13 Mar
steve_DO$DO_mgL[steve_DO$time_CST 
                %between% 
                c(ymd_hms("2018-03-13 05:09:00", tz = "America/Chicago"),
                  ymd_hms("2018-03-13 08:49:00", tz = "America/Chicago"))] <- NA
steve_DO$temp_C[steve_DO$time_CST 
                %between% 
                c(ymd_hms("2018-03-13 05:09:00", tz = "America/Chicago"),
                  ymd_hms("2018-03-13 08:49:00", tz = "America/Chicago"))] <- NA
# 19-20 Mar
steve_DO$DO_mgL[steve_DO$time_CST 
                %between% 
                c(ymd_hms("2018-04-19 23:37:00", tz = "America/Chicago"),
                  ymd_hms("2018-04-20 08:17:00", tz = "America/Chicago"))] <- NA
steve_DO$temp_C[steve_DO$time_CST 
                %between% 
                c(ymd_hms("2018-04-19 23:37:00", tz = "America/Chicago"),
                  ymd_hms("2018-04-20 08:17:00", tz = "America/Chicago"))] <- NA
```

***

## USGS Data  

### Data pull and cleanup  

Pulling data from USGS server for sensor at Desoto KS (fourth core site)  
```{r DesotoPullCleanup, include=FALSE, warning=FALSE}
siteNoDesoto <- "06892350" # USGS code for Kansas River site at Desoto, KS
pCode <- c("99133", "00060", "00065", "00300", "00301","00010") 
  # USGS parameter codes:
    # 99133 = nitrate + nitrite [mg-N/L]
    # 00060 = discharge [cfs]
    # 00065 = gage height [ft]
    # 00300 = dissolved oxygen [mg/L]
    # 00301 = dissolved oxygen [% saturation]
    # 00010 = water temperature [C]
pullBegin <- as.POSIXct("2018-02-01", format = "%Y-%m-%d") # Date for start of data pull
pullEnd <- as.POSIXct("2018-04-22", format = "%Y-%m-%d") # Date for end of data pull

# USGS data pull
desoto <- readNWISuv(siteNumbers = siteNoDesoto, parameterCd = pCode, 
                     startDate = pullBegin, endDate = pullEnd, tz = "America/Chicago") 

# Rename columns from codes to parameter names
desoto <- renameNWISColumns(desoto)
# Fix remaining names that are still parameter codes
names(desoto)[names(desoto)=="00301_Inst"] <- "DO_percentsat" 
names(desoto)[names(desoto)=="00301_Inst_cd"] <- "DO_percentsat_cd"
names(desoto)[names(desoto)=="99133_Inst"] <- "nitrateNitrite"
names(desoto)[names(desoto)=="99133_Inst_cd"] <- "nitrateNitrite_cd"

# Convert from American to SI units
# cubic foot per second to liters per second
ft3s_m3s <- function(ft3s){
  m3s <- ft3s*0.0283168
  return(m3s)
}
# foot to meters
ft_m <- function(ft){
  m <- 0.3048*ft
  return(m)
}
desoto$Flow_Inst <- ft3s_m3s(desoto$Flow_Inst)
desoto$GH_Inst <- ft_m(desoto$GH_Inst)

```

Pulling data from USGS stream gauge at Lawrence, for finding water balance
```{r LawrencePullCleanup, include=FALSE, warning=FALSE}
siteNoLawrence <- "06891080"
pCodesLawrence <- c("00060","00065")

lawrence <- readNWISuv(siteNumbers = siteNoLawrence, parameterCd = pCodesLawrence, 
                       startDate = pullBegin, endDate = pullEnd, tz = "America/Chicago") 

# Rename columns from codes to parameter names
lawrence <- renameNWISColumns(lawrence)

# convert from american to SI units
lawrence$Flow_Inst <- ft3s_m3s(lawrence$Flow_Inst)

lawrence$.Downstream.of.Bowersock.Dam._GH_Inst <- ft_m(lawrence$.Downstream.of.Bowersock.Dam._GH_Inst)

lawrence$.Upstream.of.Bowersock.Dam._GH_Inst <- ft_m(lawrence$.Upstream.of.Bowersock.Dam._GH_Inst)
```

***  

## City of Lawrence Pumping Logs  

### Data load  

Data code         |   Meaning
----------------- |----------
NA                |no sample was taken on this date
BDL_NitrateNitrite|sample concentration was less than 0.25 mg-N/L
BDL_Ammonia       |sample concentration was less than 0.30 mg-N/L

```{r FarmlandLogsLoading, include=FALSE}
FarmlandPumpingLogs <- read.csv(file = "FarmlandDailyReport_MCKformatted.csv", 
                                header = TRUE, sep = ",")
```

### Data cleanup  
```{r FarmlandLogsCleanup, include=TRUE}
# conversion from american to metric units
# million gallons to liters
MG_L <- function(MG){
  L <- MG*3.78541*10^6
  return(L)
}

FarmlandPumpingLogs$VolumePumped_MG <- MG_L(FarmlandPumpingLogs$VolumePumped_MG)
names(FarmlandPumpingLogs)[names(FarmlandPumpingLogs) == "VolumePumped_MG"] <- "VolumePumped_L"

# gallons per minute to liters per second
gpm_m3s <- function(gpm){
  m3s <- gpm*6.309E-5
  return(m3s)
}

FarmlandPumpingLogs$flowRate_Outfall001A_gpm <- gpm_m3s(FarmlandPumpingLogs$flowRate_Outfall001A_gpm)
names(FarmlandPumpingLogs)[names(FarmlandPumpingLogs) == "flowRate_Outfall001A_gpm"] <-
  "flowRate_Outfall001A_m3.s"

FarmlandPumpingLogs$flowRate_AveragePump_gpm <- gpm_m3s(FarmlandPumpingLogs$flowRate_AveragePump_gpm)
names(FarmlandPumpingLogs)[names(FarmlandPumpingLogs) == "flowRate_AveragePump_gpm"] <- 
  "flowRate_AveragePump_m3.s"

# Reformatting column data types
FarmlandPumpingLogs$Date <- mdy(FarmlandPumpingLogs$Date)
FarmlandPumpingLogs$Notes <- as.character(FarmlandPumpingLogs$Notes)
```

***  

## NEON Data   

### Data pull and cleanup  

```{r NEONpullCleanup, include=FALSE, eval=TRUE}
downloadNEONfiles <- FALSE

if (downloadNEONfiles == TRUE){
  dir.create(paste0(getwd(), "/NEONfiles"))
  
  ######## PAR ############
  getPackage(dpID = "DP1.00024.001", site_code = "UKFS",
           year_month = "2018-02", package = "basic",
           savepath = paste(getwd(), "NEONfiles", sep = "/")) # Feb at KU field station
  getPackage(dpID = "DP1.00024.001", site_code = "UKFS",
           year_month = "2018-03", package = "basic",
           savepath = paste(getwd(), "NEONfiles", sep = "/")) # March at KU field station
  #getPackage(dpID = "DP1.00024.001", site_code = "UKFS",
           #year_month = "2018-04", package = "basic",
           #savepath = getwd()) # April at KU field station 
  stackByTable(dpID = "DP1.00024.001", 
               filepath = paste0(getwd(), "/NEONfiles"), 
               savepath = paste0(getwd(), "/NEONfiles"), 
               folder = TRUE)
  
  ######## Barometric pressure ############
  getPackage(dpID = "DP1.00004.001", site_code = "UKFS",
           year_month = "2018-02", package = "basic",
           savepath = paste(getwd(), "NEONfiles", sep = "/")) # Feb at KU field station
  getPackage(dpID = "DP1.00004.001", site_code = "UKFS",
           year_month = "2018-03", package = "basic",
           savepath = paste(getwd(), "NEONfiles", sep = "/")) # March
  #getPackage(dpID = "DP1.00004.001", site_code = "UKFS",
           #year_month = "2018-04", package = "basic",
           #savepath = paste(getwd(), "NEONfiles", sep = "/")) # April
  stackByTable(dpID = "DP1.00004.001", 
               filepath = paste0(getwd(), "/NEONfiles"), 
               savepath = paste0(getwd(), "/NEONfiles"), 
               folder = TRUE)
}

PAR <- read.csv(file = paste0(getwd(), "/NEONfiles", "/stackedFiles", 
                              "/PARPAR_30min.csv"), header = TRUE)
PAR <- subset(PAR, subset = PAR$verticalPosition == 10) # take measurements that are closest to ground
PAR$startDateTime <- ymd_hms(PAR$startDateTime, tz = "America/Chicago")
PAR <- data.frame(
    dateTime = PAR$startDateTime,
    mean = PAR$PARMean,
    min = PAR$PARMinimum,
    max = PAR$PARMaximum,
    var = PAR$PARVariance
)

# PAR units are micromoles per m^2 per second

#### Barometric pressure
BarPress <- read.csv(file = paste0(getwd(), "/NEONfiles", "/stackedFiles", 
                              "/BP_30min.csv"), header = TRUE)
BarPress$startDateTime <- ymd_hms(BarPress$startDateTime, tz = "America/Chicago")
BarPress <- data.frame(
  dateTime = BarPress$startDateTime,
  mean = BarPress$staPresMean,
  min = BarPress$staPresMinimum,
  max = BarPress$staPresMaximum,
  var = BarPress$staPresVariance
)
```

***  

# Raw data visualizations  

```{r NmergedPlot, include = FALSE, echo=FALSE, warning=FALSE, fig.height=6, fig.width=10}
#combined plot of all N data on one axis
nitrataxMergedPlot <- ggplot(NULL) +
  geom_point(data = bowersock_N, aes(x = `Date and time`, 
                                   y = `Nitrate plus nitrite as mg-N/L`, 
                                   color = "Upstream"), show.legend = TRUE, size = 1) +
  geom_point(data = steve_N, aes(x = `Date and time`, 
                               y = `Nitrate plus nitrite as mg-N/L`, 
                               color = "Downstream"), show.legend = TRUE, size = 1) +
  geom_point(data = eric_N, aes(x = `Date and time`, 
                              y = `Nitrate plus nitrite as mg-N/L`, 
                              color = "Discharge point"), show.legend = TRUE, size = 1) +
  geom_point(data = desoto, aes(x = dateTime, 
                                y = nitrateNitrite, color = "Far downstream"), 
                            show.legend = TRUE, size = 1) +
  coord_cartesian(xlim = c(pullBegin, pullEnd), ylim = c(0, 25), expand = TRUE) +
  labs(y = "Nitrate plus nitrite [mg-N/L]", x = "Date", title = "", color = "Legend") +
  theme_classic() +
  theme(legend.position = "right", legend.direction = "vertical") +
  scale_color_manual(values=wes_palette(n=4, name="Darjeeling"))

nitrataxMergedPlot
```

## Individual raw plots: DO, Temp, N Plots  

Function setup for individual, simple plots for each site  
```{r simplePlotFunction, include=FALSE}
# Function name:
      # simplePlot
# Function description:
      # function to output a simple plot from specified input variables
# Input variable definitions:
      # dataset = the time series dataset from which the plot will be generated, dataframe
      # xAxis = variable to be plotted on the x axis, POSIXct format
      # yAxis = variable to be plotted on the y axis, numeric
      # plotBegin = date that plot should start, POSIXct format
      # plotEnd = date that plot should end, POSIXct format
      # yMin = minimum value of y axis, numeric
      # yMax = maximum value of y axis, numeric
      # yLabel = desired label of y axis, character string
      # xLabel = desired label of x axis, character string
      # title = desired title of plot, character string
# Outputs:
      # time series plot

simplePlot <- function(dataset, xAxis, yAxis, plotBegin, plotEnd, yMin, yMax, xLabel, yLabel, title){
  ggplot(NULL) + 
    geom_point(data = dataset, aes(x = xAxis, y = yAxis, color = title), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(plotBegin, plotEnd), 
                    ylim = c(yMin, yMax)) +
    labs(y = yLabel, x = xLabel, title = title) +
    theme_classic()
}
```

### Bowersock (Upstream)  

```{r bowersockPlots, echo=FALSE, warning=FALSE, fig.height=3, fig.width=10}
bowersockPlot_N <- simplePlot(dataset = bowersock_N, 
                              xAxis = bowersock_N$`Date and time`, 
                              yAxis = bowersock_N$`Nitrate plus nitrite as mg-N/L`,
                              plotBegin = pullBegin, plotEnd = pullEnd, xLabel = "Date",
                              yMin = 0, yMax = 1.5, 
                              yLabel = "Nitrate plus nitrite [mg-N/L]",
                              title = "Upstream") +
  scale_color_manual(values=wes_palette(n=5, name="Darjeeling")[1])

bowersockPlot_N
```

### Farmland Logs (Pipe outflow)  

```{r FarmlandPumpLogsPlots, echo=FALSE, warning=FALSE, fig.height=3, fig.width=10}
LogDateStart <- min(FarmlandPumpingLogs$Date) 
LogDateEnd <- max(FarmlandPumpingLogs$Date)

pullBegin1 <- ymd(pullBegin)
pullEnd1 <- ymd(pullEnd)

FarmlandPump_DrainageDitch_NitratePlot <- ggplot(data = FarmlandPumpingLogs, 
                                                 aes(Date, Downstream_1625RdDitch_NitrateNitrite_mgN.L)) + 
    geom_line(show.legend = FALSE, size = 1, 
              color = wes_palette(n=5, name="Royal2")[5]) +
    coord_cartesian(xlim = c(LogDateStart, LogDateEnd), ylim = c(0, 700)) +
    labs(y = "Nitrate plus nitrite [mg-N/L]", x = "Date", 
         title = "Farmland pipe outflow") +
    theme_classic() + scale_color_manual(values=wes_palette(n=5, name="Darjeeling")[1])

FarmlandPump_DrainageDitch_NitratePlot

FarmlandPump_DrainageDitch_NitratePlot_zoom <- ggplot(data = FarmlandPumpingLogs, 
                                                 aes(Date, Downstream_1625RdDitch_NitrateNitrite_mgN.L)) + 
    geom_point(show.legend = FALSE, size = 1, 
              color = wes_palette(n=5, name="Royal2")[5]) +
    coord_cartesian(xlim = c(pullBegin1, pullEnd1), ylim = c(0, 700)) +
    labs(y = "Nitrate plus nitrite [mg-N/L]", x = "Date", 
         title = "Farmland pipe outflow") +
    theme_classic() + scale_color_manual(values=wes_palette(n=5, name="Darjeeling")[1])

FarmlandPump_DrainageDitch_NitratePlot_zoom
```

### Eric (Discharge point)  

```{r ericPlots, echo=FALSE, warning=FALSE}
ericPlot_N <- simplePlot(dataset = eric_N, 
                         xAxis = eric_N$`Date and time`,
                         yAxis = eric_N$`Nitrate plus nitrite as mg-N/L`,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                         yMin = 0, yMax = 20, yLabel = "Nitrate plus nitrite [mg-N/L]",
                         title = "Discharge point") +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[1])

ericPlot_DO <- simplePlot(dataset = eric_DO, 
                         xAxis = eric_DO$time_CST,
                         yAxis = eric_DO$DO_mgL,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                         yMin = 0, yMax = 20, yLabel = "Dissolved oxygen [mg/L]",
                         title = "Discharge point") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[2])

ericPlot_temp <- simplePlot(dataset = eric_DO, 
                         xAxis = eric_DO$time_CST,
                         yAxis = eric_DO$temp_C,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = "Date",
                         yMin = -5, yMax = 25, yLabel = "Temperature [C]",
                         title = "Discharge point") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[3])

grid.arrange(ericPlot_N, ericPlot_DO, ericPlot_temp, ncol = 1, nrow = 3)
```

### Steve (5 km Downstream)  

```{r stevePlots, echo=FALSE, warning=FALSE}
# Steve (downstream)
stevePlot_N <- simplePlot(dataset = steve_N, 
                          xAxis = steve_N$`Date and time`,
                          yAxis = steve_N$`Nitrate plus nitrite as mg-N/L`,
                          plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                          yMin = 0, yMax = 1.5, yLabel = "Nitrate plus nitrite [mg-N/L]",
                          title = "Downstream (5 km)") + 
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[1])

stevePlot_DO <- simplePlot(dataset = steve_DO, 
                         xAxis = steve_DO$time_CST,
                         yAxis = steve_DO$DO_mgL,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                         yMin = 0, yMax = 20, yLabel = "Dissolved oxygen [mg/L]",
                         title = "Downstream (5 km)") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[2])

stevePlot_temp <- ericPlot_temp <- simplePlot(dataset = steve_DO, 
                         xAxis = steve_DO$time_CST,
                         yAxis = steve_DO$temp_C,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = "Date",
                         yMin = -5, yMax = 25, yLabel = "Temperature [C]",
                         title = "Downstream (5 km)") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[3])

grid.arrange(stevePlot_N, stevePlot_DO, stevePlot_temp, ncol = 1, nrow = 3)
```

### Desoto (30 km Downstream)  

```{r desotoPlots, echo=FALSE, warning=FALSE}
desotoPlot_N <- simplePlot(dataset = desoto, 
                           xAxis = desoto$dateTime,
                           yAxis = desoto$nitrateNitrite,
                           plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                           yMin = 0, yMax = 1.5, yLabel = "Nitrate plus nitrite [mg-N/L]",
                           title = "Far downstream (30 km)") +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[1])

desotoPlot_DO <- simplePlot(dataset = desoto, 
                           xAxis = desoto$dateTime,
                           yAxis = desoto$DO_Inst,
                           plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                           yMin = 0, yMax = 20, yLabel = "Dissolved oxygen [mg/L]",
                           title = "Far downstream (30 km)") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[2])

desotoPlot_temp <- simplePlot(dataset = desoto, 
                              xAxis = desoto$dateTime,
                              yAxis = desoto$Wtemp_Inst,
                              plotBegin = pullBegin, plotEnd = pullEnd, xLabel = "Date",
                              yMin = -5, yMax = 25, yLabel = "Temperature [C]",
                              title = "Far downstream (30 km)") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[3])

grid.arrange(desotoPlot_N, desotoPlot_DO, desotoPlot_temp, ncol = 1, nrow = 3)
```

## Stacked raw N data plot (include in talk)  

```{r StackedNPlot, fig.height=9, fig.width=9}
colorBlindPalette <- c("#56B4E9", "#E69F00", "#CC79A7", "#000000")

stackedNPlot <- 
  grid.arrange(
    bowersockPlot_N +
      coord_cartesian(xlim = c(pullBegin, pullEnd),
                      ylim = c(0, 1.5)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
      scale_color_manual(values = colorBlindPalette[1]),
  
    ericPlot_N +
      coord_cartesian(xlim = c(pullBegin, pullEnd),
                      ylim = c(0, 25)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
      scale_color_manual(values = colorBlindPalette[2]),
  
    stevePlot_N +
      coord_cartesian(xlim = c(pullBegin, pullEnd),
                      ylim = c(0, 1.5)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
      scale_color_manual(values = colorBlindPalette[3]),
  
    desotoPlot_N +
      coord_cartesian(xlim = c(pullBegin, pullEnd),
                      ylim = c(0, 1.5)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14)) +
      scale_color_manual(values = colorBlindPalette[4]),
  
    nrow = 4,
    ncol = 1
)

ggsave(filename = "StackedNPlot.png", plot = stackedNPlot, dpi = 500)
```

## Temporal difference in N (include in talk)
```{r Ntemporal, fig.height=3, fig.width=10}
# 4 (15 min intervals per hour) * 12 hours between midnight and noon = 48 step lag
bowersockN_daynightdiff <- diff(bowersock_N$`Nitrate plus nitrite as mg-N/L`,
                                lag = 49, differences = 1,
                                object = bowersock_N$`Date and time`)
ericN_daynightdiff <- diff(eric_N$`Nitrate plus nitrite as mg-N/L`, 
                           lag = 49, differences = 1, 
                           object = eric_N$`Date and time`)
steveN_daynightdiff <- diff(steve_N$`Nitrate plus nitrite as mg-N/L`, 
                            lag = 49, differences = 1,
                            object = steve_N$`Date and time`)
desotoN_daynightdiff <- diff(desoto$nitrateNitrite, 
                             lag = 49, differences = 1,
                             object = desoto$dateTime)

plot.ts(bowersockN_daynightdiff, col = colorBlindPalette[1])
plot.ts(ericN_daynightdiff, col = colorBlindPalette[2])
plot.ts(steveN_daynightdiff, col = colorBlindPalette[3])
plot.ts(desotoN_daynightdiff, col = colorBlindPalette[4])

# find a way to step between solar noon and midnight

```
## Combined temperature plot
```{r comboTemp, fig.width=9, fig.height=3, eval=FALSE}
comboTemp <- 
ggplot() +
  geom_point(data = desoto, aes(x = dateTime, y = Wtemp_Inst, color = "site 4"),
             show.legend = FALSE) +
  geom_point(data = steve_DO, aes(x = time_CST, y = temp_C, color = "site 2"),
             show.legend = FALSE) +
  geom_point(data = eric_DO, aes(x = time_CST, y = temp_C, color = "site 3"),
             show.legend = FALSE) +
  coord_cartesian(xlim = c(pullBegin, pullEnd), 
                  ylim = c(-5, 25)) +
  theme_classic() +
  scale_color_manual(values = colorBlindPalette[2:4]) +
  ylab("Water temperature, deg C") +
  xlab(NULL) +
  ggtitle(NULL) +
  theme(axis.text = element_text(size = 14))

ggsave(filename = "temp_comboplot.png", plot = comboTemp, dpi = 500,
       width = 10, height = 3, units = "in")
```

## Time period plots  

### Period 1:  Feb 3-6  

```{r Period1Plot, include=FALSE, fig.height=9, fig.width=5, eval=FALSE}
Period1Start <- mdy_hms("02-03-2018 12:00:00")
Period1End <- mdy_hms("02-06-2018 12:00:00")

# Grid arrange bowersock for time period #1
bowersockPlot_Period1 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,1.25)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #1
ericPlot_Period1 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,1.25)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,30)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #1
stevePlot_Period1 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,1.25)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,30)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #1
desotoPlot_Period1 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,1.25)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,30)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)
```

```{r Period1ComboPlot, echo=FALSE, fig.height=9, fig.width=15, eval=FALSE}
grid.arrange(bowersockPlot_Period1,
             ericPlot_Period1,
             stevePlot_Period1,
             desotoPlot_Period1,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 1: Feb 3-6"
)
```

### Period 2:  Feb 20-22  

```{r Period2Plot, include=FALSE, fig.height=9, fig.width=5, eval=FALSE}
Period2Start <- mdy_hms("02-20-2018 12:00:00")
Period2End <- mdy_hms("02-22-2018 12:00:00")

# Grid arrange bowersock for time period #2
bowersockPlot_Period2 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,1.5)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #2
ericPlot_Period2 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,7)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,30)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #2
stevePlot_Period2 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,1.5)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,30)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #2
desotoPlot_Period2 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,1.5)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,30)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)
```

```{r Period2ComboPlot, echo=FALSE, fig.height=9, fig.width=15, eval=FALSE}
grid.arrange(bowersockPlot_Period2,
             ericPlot_Period2,
             stevePlot_Period2,
             desotoPlot_Period2,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 2: Feb 20-22"
)
```

### Period 3:  Mar 22-25  

```{r Period3Plot, include=FALSE, fig.height=9, fig.width=5, eval=FALSE}
Period3Start <- mdy_hms("03-22-2018 12:00:00")
Period3End <- mdy_hms("03-25-2018 12:00:00")

# Grid arrange bowersock for time period #3
bowersockPlot_Period3 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #3
ericPlot_Period3 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #3
stevePlot_Period3 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #3
desotoPlot_Period3 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ncol = 1,
  nrow = 3
)
```

```{r Period3ComboPlot, echo=FALSE, fig.height=9, fig.width=15, eval=FALSE}
grid.arrange(bowersockPlot_Period3,
             ericPlot_Period3,
             stevePlot_Period3,
             desotoPlot_Period3,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 3: March 22-25"
)
```

### Period 4:  Apr 3-6  

```{r Period4Plot, include=FALSE, fig.height=9, fig.width=5, eval=FALSE}
Period4Start <- mdy_hms("04-03-2018 12:00:00")
Period4End <- mdy_hms("04-06-2018 12:00:00")

# Grid arrange bowersock for time period #4
bowersockPlot_Period4 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #4
ericPlot_Period4 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #4
stevePlot_Period4 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #4
desotoPlot_Period4 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ncol = 1,
  nrow = 3
)
```

```{r Period4ComboPlot, echo=FALSE, fig.height=9, fig.width=15, eval=FALSE}
grid.arrange(bowersockPlot_Period4,
             ericPlot_Period4,
             stevePlot_Period4,
             desotoPlot_Period4,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 4: April 3-6"
)
```

### Period 5:  Apr 11-13  

```{r Period5Plot, include=FALSE, fig.height=9, fig.width=5, eval=FALSE}
Period5Start <- mdy_hms("04-11-2018 12:00:00")
Period5End <- mdy_hms("04-13-2018 12:00:00")

# Grid arrange bowersock for time period #5
bowersockPlot_Period5 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #5
ericPlot_Period5 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #5
stevePlot_Period5 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #5
desotoPlot_Period5 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ncol = 1,
  nrow = 3
)
```

```{r Period5ComboPlot, echo=FALSE, fig.height=9, fig.width=15, eval=FALSE}
grid.arrange(bowersockPlot_Period5,
             ericPlot_Period5,
             stevePlot_Period5,
             desotoPlot_Period5,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 4: April 3-6"
)
```

## Diel cutaway plots for SFS powerpoint  
```{r dielCutaway, fig.height=2, fig.width=2, eval=FALSE}
# diel cutaway plot for powerpoint
ericPlot_N_dielCutaway <- 
  ericPlot_N +
      coord_cartesian(xlim = c(Period3Start,Period3End)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
        scale_color_manual(values = colorBlindPalette[2])

ggsave(filename = "Site2_dielCutaway.png", plot = ericPlot_N_dielCutaway, dpi = 500,
       width = 2, height = 2, units = "in")

desotoPlot_N_dielCutaway <- 
  desotoPlot_N +
      coord_cartesian(xlim = c(Period3Start,Period3End)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
        scale_color_manual(values = colorBlindPalette[4])

ggsave(filename = "Site4_dielCutaway.png", plot = desotoPlot_N_dielCutaway, dpi = 500,
       width = 2, height = 2, units = "in")

stevePlot_N_dielCutaway <- 
  stevePlot_N +
      coord_cartesian(xlim = c(Period4Start,Period4End),
                      ylim = c(0,1.5)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
        scale_color_manual(values = colorBlindPalette[3])

ggsave(filename = "Site3_dielCutaway.png", plot = stevePlot_N_dielCutaway, dpi = 500,
       width = 2, height = 2, units = "in")

```

## PAR plot
```{r PARplotting, fig.height=3, fig.width=9, eval=FALSE}
# calculate sum of PAR mean values
PAR$PARMean_sum <- cumsum(PAR$PARMean)

# convert PAR units (from umol m^-2 s^-1 to mol m^-2 d^-1)
umolm2s_to_molm2d <- function(umol_m2_s){
  mol_m2_s <- umol_m2_s*1.0E-6
  mol_m2_d <- mol_m2_s*86400
  return(mol_m2_d)
}

PAR$PARMean_sum_molm2d <- umolm2s_to_molm2d(PAR$PARMean_sum)

#convert PAR units (from umol m^-2 s^-1 to mol m^-2 s^-1)
umol_mol <- function(umol){
  mol <- umol*1.0E-6
  return(mol)
}

PAR$PARMean_sum_molm2s <- umol_mol(PAR$PARMean_sum)

#ok our raw values are on the same magnitide as the Lupon paper, but the converted values are not similar at all, wth

PAR_rawPlot <- 
  ggplot(NULL) + 
    geom_line(data = PAR, aes(x = startDateTime, y = PARMean), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(pullBegin, pullEnd)) +
    labs(y = "PAR, 
         umol m^-2 s^-1", 
         x = "Date") +
    theme_classic() +
    theme(axis.text = element_text(size = 14),
          axis.title = element_text(size = 14))

PAR_sumPlot <- 
  ggplot(NULL) + 
    geom_area(data = PAR, aes(x = startDateTime, y = PARMean_sum), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(pullBegin, pullEnd)) +
    labs(y = "Sum PAR, 
         umol m^-2 s^-1", 
         x = "Date") +
    theme_classic() +
    theme(axis.text = element_text(size = 14),
          axis.title = element_text(size = 14))

PAR_sumPlot_convertunits_molday <- 
  ggplot(NULL) + 
    geom_area(data = PAR, aes(x = startDateTime, y = PARMean_sum_molm2d), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(pullBegin, pullEnd)) +
    labs(y = "Sum PAR, 
         mol m^-2 d^-1", 
         x = "Date") +
    theme_classic() +
    theme(axis.text = element_text(size = 14),
          axis.title = element_text(size = 14))

PAR_sumPlot_convertunits_mol <- 
  ggplot(NULL) + 
    geom_area(data = PAR, aes(x = startDateTime, y = PARMean_sum_molm2s), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(pullBegin, pullEnd)) +
    labs(y = "Sum PAR, 
         mol m^-2 s^-1", 
         x = "Date") +
    theme_classic() +
    theme(axis.text = element_text(size = 14),
          axis.title = element_text(size = 14))

PAR_rawPlot
PAR_sumPlot
PAR_sumPlot_convertunits_mol
PAR_sumPlot_convertunits_molday

ggsave(filename = "PAR_rawPlot.png", plot = PAR_rawPlot, dpi = 500,
       width = 10, height = 3, units = "in")
ggsave(filename = "PAR_sumPlot.png", plot = PAR_sumPlot, dpi = 500,
       width = 10, height = 3)
ggsave(filename = "PAR_sumPlot_molm2sec.png", plot = PAR_sumPlot_convertunits_mol, dpi = 500,
       width = 10, height = 3)
ggsave(filename = "PAR_sumPlot_molm2day.png", plot = PAR_sumPlot_convertunits_molday, dpi = 500,
       width = 10, height = 3)
```

# Water Balance  

## Computation  

```{r waterBalanceComputation, include=TRUE, eval=FALSE}
#subset data frames
desoto_sub <- data.frame(desoto$dateTime, desoto$Flow_Inst)
names(desoto_sub) <- c("dateTime", "Flow_Inst")
desoto_sub$dateTime <- ymd_hms(desoto_sub$dateTime)

lawrence_sub <- data.frame(lawrence$dateTime, lawrence$Flow_Inst)
names(lawrence_sub) <- c("dateTime", "Flow_Inst")
lawrence_sub$dateTime <- ymd_hms(lawrence_sub$dateTime)

# combine data frames
waterBal <- merge(desoto_sub, lawrence_sub, 
                  by = "dateTime", suffixes = c(".desoto", ".lawrence"))

#calculate difference between downstream and upstream gauge (balance = downstream discharge - upstream)
waterBal$difference <- waterBal$Flow_Inst.desoto - waterBal$Flow_Inst.lawrence
```

## Plotting  

```{r waterBalancePlotting, echo=FALSE, fig.height=3, fig.width=10, warning=FALSE, eval=FALSE}
# plotting flow at upstream and downstream locations on same time series graph
ggplot() +
  geom_line(data = desoto, aes(x = dateTime, y = Flow_Inst, color = "Desoto")) +
  geom_line(data = lawrence, aes(x = dateTime, y = Flow_Inst, color = "Lawrence"))

# plot the water balance graph centered on 0: 
      # positive values = gaining stream
      # negative values = losing stream
waterBal_plot <- ggplot() +
  geom_line(data = waterBal, 
            aes(x = dateTime, y = difference, color = "difference"),
            show.legend = FALSE, 
            color = colorBlindPalette[4]) +
  geom_hline(aes(yintercept = mean(na.omit(waterBal$difference))),
             color = "red",
             linetype = "solid") +
  coord_cartesian(xlim = c(pullBegin, pullEnd), 
                  ylim = c(-50, 50)) +
  labs(y = "Difference between 
downstream and 
upstream flow, m3/s",
       x = "Date", 
       title = "Water balance of study reach") +
  theme_classic() +
  ggtitle(NULL) +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 14))

ggsave(filename = "waterBal_plot.png", plot = waterBal_plot, dpi = 500,
       width = 10, height = 3, units = "in")
```

***  

# Metabolism modeling

```{r StreamMetabolizer, eval=FALSE}
# Desoto dataframe setup
desoto_longitude <- -94.964616
# calculate solar time
PAR$dateTime_solar <- calc_solar_time(PAR$startDateTime, longitude = desoto_longitude)
desoto$dateTime_solar <- calc_solar_time(desoto$dateTime, longitude = desoto_longitude)
# estimate stream depth from discharge data
  # using d = c*Q^f Leopold and Maddock 1953
  # default values for c and f as suggested in Raymond et al 2012
      # c = 0.409 m, f = 0.294 **verify if these are representative of Kaw
desoto$depth <- calc_depth(desoto$Flow_Inst)
  # this gives us close the the GH readings for depth
#assemble data frame of data needed for metabolism model
desoto_MetabData <- merge.data.frame(desoto, PAR, 
                                     by = intersect(names(desoto), names(PAR)))
desoto_MetabData <- desoto_MetabData[, c("dateTime_solar", "Wtemp_Inst", "Flow_Inst",
                                         "GH_Inst", "DO_Inst", "DO_percentsat", "depth",
                                         "PARMean")]
# comparison between using gage height and estimated depth
    # using USGS measured gage height
desoto_MetabData <- subset(desoto_MetabData, select = -c(GH_Inst))
names(desoto_MetabData) <- c("solar.time", "temp.water", "discharge",
                              "DO.obs", "DO.sat", "depth", "light")

# model fitting
    # using the basic MLE model
mle_name <- mm_name(type='mle', ode_method = "trapezoid")
mle_specs <- specs(mle_name)
mle_specs <- revise(mle_specs, split_dates = FALSE, verbose = TRUE, GPP_fun = "limlight",
                    ER_fun = "q10temp", deficit_src = "DO_obs")
mm_mle_desoto <- metab(mle_specs, data = desoto_MetabData)

# model plotting
plot_metab_preds(mm_mle_desoto)
plot_DO_preds(mm_mle_desoto)

# view errors
get_params(mm_mle_desoto) %>% select(date, warnings, errors)

# trying a bayseian model for better prediction of multi-day metabolism
bayes_name <- mm_name(type = "bayes", pool_K600 = "binned")
bayes_specs <- specs(bayes_name) 
bayes_specs <- revise(bayes_specs, burnin_steps=500, saved_steps=500,
                      split_dates = FALSE, verbose = TRUE, GPP_fun = "limlight",
                      ER_fun = "q10temp", deficit_src = "DO_obs", ode_method = "trapezoid",
                      control = list(max_treedepth = 30))
mm_bayes_desoto <- metab_bayes(specs = bayes_specs, data = desoto_MetabData)
mm_bayes_desoto_stanobj <- get_mcmc(mm_bayes_desoto)

traceplot(mm_bayes_desoto_stanobj)
get_fit(mm_bayes_desoto)$warnings


get_params(mm_bayes_desoto) %>% select(date, warnings, errors)

plot_metab_preds(mm_bayes_desoto)
plot_DO_preds(mm_bayes_desoto)

# what if we estimate K first, then find GPP and ER with fixed K
kmodel_name <- mm_name(type = "Kmodel", engine = "mean")
kmodel_desoto <- metab_Kmodel(specs = kmodel_name, data = desoto_MetabData)
```

```{r MetabolismModel_HotchkissHall_Equations}
# simpler hotchkiss & hall approach, let's start with steve [supp materials from lamberti textbook]

# [2] calculate oxygen saturation at temperature (the minidot already does this)
osat<- function(temp, bp) {
	
	tstd<-log((298.15-temp) / (273.15 + temp))
	
	a0<-2.00907
	a1<-3.22014
	a2<-4.0501
	a3<-4.94457
	a4<- -0.256847
	a5<- 3.88767
	
	u<-10^(8.10765-(1750.286/(235+temp)))
	
	sato<-(exp(a0 + a1*tstd + a2*tstd^2 + a3*tstd^3 + a4*tstd^4+a5*tstd^5))*((bp-u)/(760-u))*1.42905
	sato
}

# [3] calculate barometric pressure

## Function to correct barometric pressure for altitude. From Colt (2012).
## This function gives bp in mmHg for altitude given nearby measurement of standardized barometric pressure. 
	## temp is degC 
	## alt is m
	## bpst is in inches of Hg and the sort of data you will find from U.S. weather stations.  Delete the *25.4 if you in the rest of the world where pressure is given in metric units
####function returns mm of Hg
bpcalc<- function(bpst, alt) {
  bpst*25.4*exp((-9.80665*0.0289644*alt)/(8.31447*(273.15+15)))
}

# [4] load gas exchange (K) functions

## This code estimates K600 for KO2 at a given temperature. From Wanninkhof (1992).
K600fromO2<-function (temp, KO2) {
    ((600/(1800.6 - (120.1 * temp) + (3.7818 * temp^2) - (0.047608 * temp^3)))^-0.5) * KO2
}

# [5] load river metabolism function 

# parameter names (and units)
	# oxy.mod = modeled O2 (mg/L)
	# oxy = O2 data (mg/L)
	# MET[1] = GPP = estimated daily gross primary production (g O2 m-2 d-1); + flux of O2 production
	# MET[2] = ER = estimated daily ecosystem respiration (g O2 m-2 d-1); - flux of O2 consumption 
	# MET[3] = K = estimated K600 (d-1)
	# z = estimated site depth (m)
	# Kcor = KO2 corrected for temperature, calculated from K600 (d-1)
	# bp = barometric pressure (mmHg)
	# temp = water temperature (C)
	# light = PAR data (or modlight from above light function)
	# ts = time step of O2 data from logger (10 min intervals --> units are day, so 10/1440=0.06944)

Kcor<-function (temp,K600) {
	K600/(600/(1800.6-(temp*120.1)+(3.7818*temp^2)-(0.047608*temp^3)))^-0.5
}

# Model to calculate GPP, ER and K simultaneously
  # This model is advantageous in the sense that one can estimate K from the data, 
  # but beware that it may be an overparameterized model.  

# rivermetabK is the master function that calls the MLE function (onestationmleK) and plotting function (onestationplot) below
rivermetabK<-function(o2file, z, bp, ts){

  temp<-o2file$temp
  oxy<-o2file$oxy
  light<-o2file$light

  ##This calls onestationmleK (below) to calculate metabolism by non-linear minimization. We use nlm() function in R stats package; for more information see "help(nlm)"  The first argument is the function to be minimized, the second defines the starting values.  The function that is minimized (onestationmleK, see below) always has as its first argument, a vector of parameters (MET), and second argument a vector of starting values for those parameters, p=c(3,-5, 10).

  river.mle<-nlm(onestationmleK, p=c(3,-5, 10), 
                 oxy=oxy, z=z, temp=temp, 
                 light=light, bp=bp, ts=ts)

  ##plot modeled and measaured O2 given MLE estimates of GPP, ER, and K600.  It calls a function below onestationplot()

  onestationplot(GPP = river.mle$estimate[1],
                 ER = river.mle$estimate[2],
                 oxy=oxy, z=z, temp=temp, light=light, 
                 K=river.mle$estimate[3], bp=bp, ts=ts)
  
  ##return GPP, ER, K600, and MLE values
	b <- list(GPP = river.mle$estimate[1], 
	          ER = river.mle$estimate[2], 
	          K600 = river.mle$estimate[3], 
	          neglogL = river.mle$minimum[1])
	b
}

# This function returns the negative log likelihood value given O2 data and estimates of GPP, ER, and K (which is vector MET); is included in master rivermetabK function above
onestationmleK <- function(MET, temp, oxy, light, z, bp, ts) {

  oxy.mod <- numeric(length(data))
  # give starting value from oxygen data; this is the only time O2 data is used to model GPP and ER
  oxy.mod[1] <- oxy[1]

  # this is the metabolism equation as in Van de Bogert et al 2007 L&OMethods
  for (i in 2:length(oxy)) {
    oxy.mod[i] <- oxy.mod[i-1] + 
                  ((MET[1]/z) * (light[i]/sum(light))) +
                  MET[2]*ts/z + 
                  (Kcor(temp[i],MET[3])) * ts * (osat(temp[i],bp) - oxy.mod[i-1]) 
    }

  # below is MLE calculation; output is -log likelihood
  # diff in measured and modeled O2
  sqdiff <- (oxy-oxy.mod)^2

  # likelihood function
  L <- length(oxy) * (log(((sum(sqdiff)/length(oxy))^0.5)) + 
       0.5*log(6.28)) + 
       ((2*sum(sqdiff)/length(oxy))^-1) * sum(sqdiff)
	L
}

# this function plots modeled O2 and O2 data from estimates of daily GPP, ER, and K; is included in master rivermetabK function above
# Calls same metabolism equation as in mle function, but plots modeled O2 as a function of GPP, ER, and K estimates from mle
# use this to visually assess your model estimates (should be good agreement between modeled and measured O2)
onestationplot <- function(GPP, ER, oxy, z, temp, K, light, bp, ts) {

  oxy.mod<-numeric(length(oxy))
  oxy.mod[1]<-oxy[1]

  # this is the metabolism equation as in Van de Bogert et al (2007) L&OMethods
  for (i in 2:length(oxy)) { 
    oxy.mod[i] <- oxy.mod[i-1] + 
                  ((GPP/z)*(light[i]/sum(light))) +
                  ER*ts/z + 
                  (Kcor(temp[i],K)) * ts * (osat(temp[i],bp)-oxy.mod[i-1]) 
    }

  plot(seq(1:length(oxy)),
       oxy.mod, 
       type="l", xlab="Time", ylab="Dissolved oxygen  (mg/L)", 
       cex.lab=1.5, cex.axis=1.5, lwd=2)
  points(seq(1:length(oxy)), oxy)
}
```

```{r MetabolismModel_HotchkissHall_Evaluation}
# [1] load data, date and time must be in different columns

steve_metab <- 
data.frame(
  dateTime = ymd_hms(steve_DO$time_CST, tz = "America/Chicago")
)

eric_metab <- 
data.frame(
  dateTime = ymd_hms(eric_DO$time_CST, tz = "America/Chicago")
)

# [2] calculate oxygen saturation at temperature (the minidot already does this)

steve_metab$DOmgL <- steve_DO$DO_mgL
steve_metab$temp <- steve_DO$temp_C

eric_metab$DOmgL <- eric_DO$DO_mgL
eric_metab$temp <- eric_DO$temp_C

# [3] calculate barometric pressure

steve_alt <- 249.02 # m
steve_pressure <- 
data.frame(
  dateTime = BarPress$dateTime,
  mean_pressure = bpcalc(bpst = BarPress$mean, alt = steve_alt)
)

eric_alt <- 246.89 # m
eric_pressure <- 
data.frame(
  dateTime = BarPress$dateTime,
  mean_pressure = bpcalc(bpst = BarPress$mean, alt = eric_alt)
)

# [4] load gas exchange (K) functions

steve_metab$K600 <- K600fromO2(temp = steve_metab$temp, KO2 = steve_metab$DOmgL)

eric_metab$K600 <- K600fromO2(temp = eric_metab$temp, KO2 = eric_metab$DOmgL)

# [5] depth
#     using streamMetabolizer package and desoto discharge data here. this won't be entirely accurate.
# estimate stream depth from discharge data
  # using d = c*Q^f Leopold and Maddock 1953
  # default values for c and f as suggested in Raymond et al 2012
      # c = 0.409 m, f = 0.294 **verify if these are representative of Kaw
steve_depth <- 
data.frame(
  dateTime = ymd_hms(desoto$dateTime, tz = "America/Chicago"),
  steve_z = calc_depth(desoto$Flow_Inst)
)

eric_depth <- 
data.frame(
  dateTime = ymd_hms(desoto$dateTime, tz = "America/Chicago"),
  eric_z = calc_depth(desoto$Flow_Inst)
)

# [6] combine metabolism data frame into one, while making sure dates match

# need to combine steve_metab with steve_pressure, steve_depth, and PAR
steve_metab$dateTime <- round_date(steve_metab$dateTime, "10 minutes") # round to nearest 10 min interval
eric_metab$dateTime <- round_date(eric_metab$dateTime, "10 minutes") 

# merge
steve_metab <- 
  merge(steve_metab,
        steve_pressure,
        by = "dateTime")
steve_metab <- 
  merge(steve_metab,
        steve_depth,
        by = "dateTime")
steve_metab <- 
  merge(steve_metab,
        PAR,
        by = "dateTime")
steve_metab <- 
  data.frame(dateTime = steve_metab$dateTime,
             oxy = steve_metab$DOmgL,
             temp = steve_metab$temp,
             K600 = steve_metab$K600,
             bp = steve_metab$mean_pressure,
             z = steve_metab$steve_z,
             light = steve_metab$mean)

eric_metab <- 
  merge(eric_metab,
        eric_pressure,
        by = "dateTime")
eric_metab <- 
  merge(eric_metab,
        eric_depth,
        by = "dateTime")
eric_metab <- 
  merge(eric_metab,
        PAR,
        by = "dateTime")
eric_metab <- 
  data.frame(dateTime = eric_metab$dateTime,
             oxy = eric_metab$DOmgL,
             temp = eric_metab$temp,
             K600 = eric_metab$K600,
             bp = eric_metab$mean_pressure,
             z = eric_metab$eric_z,
             light = eric_metab$mean)

# [7] run metabolism model
steve_metab_output <- rivermetabK(o2file = na.omit(steve_metab), 
                                  z = mean(steve_metab$z, na.rm = TRUE), 
                                  bp = mean(steve_metab$bp, na.rm = TRUE), 
                                  ts = 0.02083333)
steve_metab_output

eric_metab_output <- rivermetabK(o2file = na.omit(eric_metab), 
                                  z = mean(eric_metab$z, na.rm = TRUE), 
                                  bp = mean(eric_metab$bp, na.rm = TRUE), 
                                  ts = 0.02083333)
eric_metab_output

# function to subset metabolism data and run model for specific time period
metab_timeperiods <- function(metab_dataframe, startTime, endTime){
  metab_timeperiod_subsection <- metab_dataframe[metab_dataframe$dateTime 
                                                 %between% 
                                                   c(ymd_hms(startTime, tz = "America/Chicago"),
                                                     ymd_hms(endTime, tz = "America/Chicago")),]
  metab_output <- rivermetabK(o2file = metab_timeperiod_subsection,
                              z = mean(metab_timeperiod_subsection$z, na.rm = TRUE),
                              bp = mean(metab_timeperiod_subsection$bp, na.rm = TRUE),
                              ts = 0.02083333)
  return(metab_output)
}

# steve: Feb 3-6
metab_timeperiods(steve_metab, "2018-02-03 00:00:00", "2018-02-05 00:00:00")

# steve: Feb 20 - 22
metab_timeperiods(steve_metab, "2018-02-20 00:00:00", "2018-02-22 00:00:00")

# eric needs a different time period, but close to this one in feb
metab_timeperiods(eric_metab, "2018-02-20 00:00:00", "2018-02-22 00:00:00")

# steve: Mar 22-25
metab_timeperiods(steve_metab, "2018-03-22 00:00:00", "2018-03-25 00:00:00")

# eric: Mar 22-25
metab_timeperiods(eric_metab, "2018-03-22 00:00:00", "2018-03-25 00:00:00")

# steve: Apr 11-13 (dont have april PAR)
metab_timeperiods(steve_metab, "2018-04-11 00:00:00", "2018-04-13 00:00:00") 

```
