---
title: 'KAWN RAPID: Sensor Data Analysis'
author: "Michelle Catherine Kelly"
date: "22 April 2018"
output:
  html_document:
    theme: yeti
    df_print: paged
    toc: yes
    number_sections: true
---

```{r setup, echo = FALSE, warning=FALSE, error=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.height = 8, 
                      fig.width = 10, 
                      cache=TRUE, # enable caching globally
                      echo=TRUE) # all code will print to screen

library(XML)
library(lubridate)
library(ggplot2)
library(gridExtra)
library(grid)
library(dataRetrieval) # USGS
library(wesanderson) # pallets
library(zoo)
#library(devtools)
#install_github("NEONScience/NEON-utilities/neonUtilities", dependencies = TRUE)
library(neonUtilities)
library(streamMetabolizer)
library(leaflet)
```

***  

# Overview

This is a **working document** for analyzing sensor data from the NSF RAPID Kansas River Nitrogen Cycling Project

***  

# Data Import  

This section contains all data loading and cleanup chunks  

Data pull = data is taken from an online host (USGS, NEON)
Data load = data is taken from local file

## Nitratax Data  

### Data pull  

**Nitratax_XMLtoCSV:** Function to convert raw-from-sensor .xml file to more convenient .csv file  
```{r Nitratax_XMLtoCSV, include=FALSE}
# Function name:
      # Nitratax_XMLtoCSV
# Function description:
      # Convert output format from Nitratax sensor (.xml) into .csv file
# Input variable definitions:
      # filename = .xml file to be converted, character  string
      # sensor = character string of sensor name, will be outputted in .csv file name
      # deployDate = start date of sensor operation, YYYY-MM-DD character string
# Outputs:
      # .csv file titled "KansasR_Nitratax_<sensor>.csv"

Nitratax_XMLtoCSV <- function(filename, sensor, deployDate){
  
  xmlData <- XML::xmlParse(file = filename)
  xmlData <- XML::xmlToDataFrame(xmlData, homogeneous = F, stringsAsFactors = F)
  xmlData <- xmlData[-(1:6),] # taking out text at top of dataframe
  
  for (count in 1:length(xmlData)){
    names(xmlData)[count] <- as.character(xmlData[1,count])
  }
  
  xmlData <- xmlData[-1,] # taking out character rows
  xmlData <- xmlData[,-1] # taking out first blank column
  
  xmlData$`  TIME  ` <- lubridate::as_datetime(xmlData$`  TIME  `, 
                                               tz = "America/Chicago", 
                                               format = "%m/%d/%Y %H:%M:%S")
  xmlData$`  NITRATE CONC.  ` <- as.numeric(xmlData$`  NITRATE CONC.  `)
  xmlData$`  ER  ` <- as.numeric(xmlData$`  ER  `)
  xmlData$`  EM  ` <- as.numeric(xmlData$`  EM  `)
  
  xml_trunkated <- xmlData[xmlData$`  TIME  `>ymd(deployDate),] # subset only data from deploy onwards
  
  xml_trunkated <- data.frame(xml_trunkated$`  TIME  `, 
                              xml_trunkated$`  NITRATE CONC.  `)
  names(xml_trunkated) <- c("Date and time", "Nitrate plus nitrite as mg-N/L")
  CSV_filename <- paste("KansasR_Nitratax_", 
                        sensor, 
                        ".csv", sep = "")
  
  write.table(xml_trunkated, 
              file = CSV_filename,
              sep = ",", row.names = FALSE)
  return(xml_trunkated)
  
}
```

Import of Nitratax data into R environment
```{r NitrataxLoading, include=FALSE}
# Variable descriptions:    
      # loadfromCSV = logical vector, if TRUE data will be loaded from .csv files
                                    # if FALSE data will be converted from .xml to .csv
                                    # (computationally much faster to load from .csv)
      # bowersock_N = Nitratax sensor located at the bowersock dam upstream of waste release
      # eric_N = Nitratax sensor located at the waste release point
      # steve_N = Nitratax sensor located about ~5 miles downstream of bowersock

loadfromCSV <- TRUE 

if (loadfromCSV == TRUE){
  
  bowersock_N <- read.csv(file = "KansasR_Nitratax_Bowersock.csv", 
                          header = TRUE,
                          colClasses = c("POSIXct", "numeric"))
  eric_N <- read.csv(file = "KansasR_Nitratax_Eric.csv", 
                     header = TRUE,
                     colClasses = c("POSIXct", "numeric"))
  steve_N <- read.csv(file = "KansasR_Nitratax_Steve.csv", 
                      header = TRUE,
                      colClasses = c("POSIXct", "numeric"))
  
  names(bowersock_N) <- c("Date and time", "Nitrate plus nitrite as mg-N/L")
  names(eric_N) <- c("Date and time", "Nitrate plus nitrite as mg-N/L")
  names(steve_N) <- c("Date and time", "Nitrate plus nitrite as mg-N/L")
  
  cat("data loaded from .csv file")
  
}
if (loadfromCSV == FALSE) {
  
  bowersock_N <- Nitratax_XMLtoCSV(filename = "NITRATAX_Bowersock_Pulled04-13-2018.xml", 
                                   sensor = "Bowersock", 
                                   deployDate = "2018-01-13")
  eric_N <- Nitratax_XMLtoCSV(filename = "NITRATAX_Eric_Pulled04-13-2018.xml", 
                              sensor = "Eric", 
                              deployDate = "2018-02-19")
  steve_N <- Nitratax_XMLtoCSV(filename = "NITRATAX_Steve_Pulled04-20-2018.xml", 
                               sensor = "Steve", 
                               deployDate = "2018-01-31")
  
  cat("data loaded from .xml file")
  
}
```

### Data cleanup  

Cleanup of Nitratax data files
```{r NitrataxCleanup, include=FALSE}
if (loadfromCSV == FALSE){
  
  # Eric sensor was buried under sediment from 05-Mar to 15-Mar, setting these measurements to NA
  dateSedimentStartEric <- lubridate::as_datetime("2018-03-05 11:00:00")
  dateSedimentEndEric <- lubridate::as_datetime("2018-03-15 00:00:00")
  eric_N$`Nitrate plus nitrite as mg-N/L`[eric_N$`Date and time` >= dateSedimentStartEric 
                                          & 
                                            eric_N$`Date and time` <= dateSedimentEndEric] <- NA

  # Setting Steve to NA for all measurements of "0", due to sediment issues
  steve_N$`Nitrate plus nitrite as mg-N/L`[steve_N$`Nitrate plus nitrite as mg-N/L` <= 0] <- NA

  # Setting Steve to NA during time period of sediment burial
  dateSedimentStartSteve <- lubridate::as_datetime("2018-03-12 15:00:00")
  dateSedimentEndSteve <- lubridate::as_datetime("2018-03-27 11:30:00")
  steve_N$`Nitrate plus nitrite as mg-N/L`[steve_N$`Date and time`>=dateSedimentStartSteve 
                                           & 
                                             steve_N$`Date and time`<=dateSedimentEndSteve] <- NA

}
```

***  

## miniDOT Data  

Loading miniDOT sensor files: dissolved oxygen and temperature data  
```{r DOloading, include=FALSE}
steve_DO <- read.table(file = "miniDOT_Steve_Pulled04-20-2018.txt", header = TRUE,
                       sep = ",", skip = 8, stringsAsFactors = FALSE,
                       colClasses = c("numeric", "POSIXct", "POSIXct", "numeric",
                                      "numeric", "numeric", "numeric", "numeric"),
                       col.names = c("unixTimestamp", "time_UTC", "time_CST", "battery_V",
                                     "temp_C", "DO_mgL", "DO_sat", "Q"))

eric_DO <- read.table(file = "miniDOT_Eric_Pulled04-04-2018.txt", header = TRUE,
                       sep = ",", skip = 8, stringsAsFactors = FALSE,
                       colClasses = c("numeric", "POSIXct", "POSIXct", "numeric",
                                      "numeric", "numeric", "numeric", "numeric"),
                       col.names = c("unixTimestamp", "time_UTC", "time_CST", "battery_V",
                                     "temp_C", "DO_mgL", "DO_sat", "Q"))

```

***

## USGS Data  

### Data pull  

Pulling data from USGS server for sensor at Desoto KS (fourth core site)  
```{r DesotoPull, include=FALSE, warning=FALSE}
siteNoDesoto <- "06892350" # USGS code for Kansas River site at Desoto, KS
pCode <- c("99133", "00060", "00065", "00300", "00301","00010") 
  # USGS parameter codes:
    # 99133 = nitrate + nitrite [mg-N/L]
    # 00060 = discharge [cfs]
    # 00065 = gage height [ft]
    # 00300 = dissolved oxygen [mg/L]
    # 00301 = dissolved oxygen [% saturation]
    # 00010 = water temperature [C]
pullBegin <- as.POSIXct("2018-02-01", format = "%Y-%m-%d") # Date for start of data pull
pullEnd <- as.POSIXct("2018-04-22", format = "%Y-%m-%d") # Date for end of data pull

# USGS data pull
desoto <- readNWISuv(siteNumbers = siteNoDesoto, parameterCd = pCode, 
                     startDate = pullBegin, endDate = pullEnd, tz = "America/Chicago") 
```

Pulling data from USGS stream gauge at Lawrence, for finding water balance
```{r LawrencePull, include=FALSE, warning=FALSE}
siteNoLawrence <- "06891080"
pCodesLawrence <- c("00060","00065")

lawrence <- readNWISuv(siteNumbers = siteNoLawrence, parameterCd = pCodesLawrence, 
                       startDate = pullBegin, endDate = pullEnd, tz = "America/Chicago") 
```

### Data cleanup  

Desoto data cleanup
```{r DesotoCleanup, include=TRUE}
# Rename columns from codes to parameter names
desoto <- renameNWISColumns(desoto)
# Fix remaining names that are still parameter codes
names(desoto)[names(desoto)=="00301_Inst"] <- "DO_percentsat" 
names(desoto)[names(desoto)=="00301_Inst_cd"] <- "DO_percentsat_cd"
names(desoto)[names(desoto)=="99133_Inst"] <- "nitrateNitrite"
names(desoto)[names(desoto)=="99133_Inst_cd"] <- "nitrateNitrite_cd"

# Convert from American to SI units
# cubic foot per second to liters per second
ft3s_m3s <- function(ft3s){
  m3s <- ft3s*0.0283168
  return(m3s)
}
# foot to meters
ft_m <- function(ft){
  m <- 0.3048*ft
  return(m)
}
desoto$Flow_Inst <- ft3s_m3s(desoto$Flow_Inst)
desoto$GH_Inst <- ft_m(desoto$GH_Inst)
```

Lawrence data cleanup
```{r LawrenceCleanup, include=TRUE}
# Rename columns from codes to parameter names
lawrence <- renameNWISColumns(lawrence)

# convert from american to SI units
lawrence$Flow_Inst <- ft3s_m3s(lawrence$Flow_Inst)

lawrence$.Downstream.of.Bowersock.Dam._GH_Inst <- ft_m(lawrence$.Downstream.of.Bowersock.Dam._GH_Inst)

lawrence$.Upstream.of.Bowersock.Dam._GH_Inst <- ft_m(lawrence$.Upstream.of.Bowersock.Dam._GH_Inst)
```

***  

## City of Lawrence Pumping Logs  

### Data load  

Data code         |   Meaning
----------------- |----------
NA                |no sample was taken on this date
BDL_NitrateNitrite|sample concentration was less than 0.25 mg-N/L
BDL_Ammonia       |sample concentration was less than 0.30 mg-N/L

```{r FarmlandLogsLoading, include=FALSE}
FarmlandPumpingLogs <- read.csv(file = "FarmlandDailyReport_MCKformatted.csv", 
                                header = TRUE, sep = ",")
```

### Data cleanup  
```{r FarmlandLogsCleanup, include=TRUE}
# conversion from american to metric units
# million gallons to liters
MG_L <- function(MG){
  L <- MG*3.78541*10^6
  return(L)
}

FarmlandPumpingLogs$VolumePumped_MG <- MG_L(FarmlandPumpingLogs$VolumePumped_MG)
names(FarmlandPumpingLogs)[names(FarmlandPumpingLogs) == "VolumePumped_MG"] <- "VolumePumped_L"

# gallons per minute to liters per second
gpm_m3s <- function(gpm){
  m3s <- gpm*6.309E-5
  return(m3s)
}

FarmlandPumpingLogs$flowRate_Outfall001A_gpm <- gpm_m3s(FarmlandPumpingLogs$flowRate_Outfall001A_gpm)
names(FarmlandPumpingLogs)[names(FarmlandPumpingLogs) == "flowRate_Outfall001A_gpm"] <-
  "flowRate_Outfall001A_m3.s"

FarmlandPumpingLogs$flowRate_AveragePump_gpm <- gpm_m3s(FarmlandPumpingLogs$flowRate_AveragePump_gpm)
names(FarmlandPumpingLogs)[names(FarmlandPumpingLogs) == "flowRate_AveragePump_gpm"] <- 
  "flowRate_AveragePump_m3.s"

# Reformatting column data types
FarmlandPumpingLogs$Date <- mdy(FarmlandPumpingLogs$Date)
FarmlandPumpingLogs$Notes <- as.character(FarmlandPumpingLogs$Notes)
```

***  

## NEON Data   

### Data pull  

```{r NEONpull, include=FALSE, eval=TRUE}
downloadNEONfiles <- FALSE

if (downloadNEONfiles == TRUE){
  dir.create(paste0(getwd(), "/NEONfiles"))
  
  getPackage(dpID = "DP1.00024.001", site_code = "UKFS",
           year_month = "2018-02", package = "basic",
           savepath = paste(getwd(), "NEONfiles", sep = "/")) # Feb at KU field station
  getPackage(dpID = "DP1.00024.001", site_code = "UKFS",
           year_month = "2018-03", package = "basic",
           savepath = paste(getwd(), "NEONfiles", sep = "/")) # March at KU field station
  #getPackage(dpID = "DP1.00024.001", site_code = "UKFS",
           #year_month = "2018-04", package = "basic",
           #savepath = getwd()) # April at KU field station - wont be released until end of april
  stackByTable(dpID = "DP1.00024.001", 
               filepath = paste0(getwd(), "/NEONfiles"), 
               savepath = paste0(getwd(), "/NEONfiles"), 
               folder = TRUE)
}

PAR <- read.csv(file = paste0(getwd(), "/NEONfiles", "/stackedFiles", 
                              "/PARPAR_30min.csv"), header = TRUE)
```

### Data cleanup  

```{r NEONcleanup, include=FALSE, eval=TRUE}
# data cleanup
PAR <- subset(PAR, subset = PAR$verticalPosition == 10) # take measurements that are closest to ground

PAR <- PAR[,-c(1:4, 6, 11:22)] #drop unneccess columns
PAR$startDateTime <- ymd_hms(PAR$startDateTime)
tz(PAR$startDateTime) <- "America/Chicago"

# PAR units are micromoles per m^2 per second
```

***  

# Raw data visualizations  

```{r NmergedPlot, include = FALSE, echo=FALSE, warning=FALSE, fig.height=6, fig.width=10}
#combined plot of all N data on one axis
nitrataxMergedPlot <- ggplot(NULL) +
  geom_point(data = bowersock_N, aes(x = `Date and time`, 
                                   y = `Nitrate plus nitrite as mg-N/L`, 
                                   color = "Upstream"), show.legend = TRUE, size = 1) +
  geom_point(data = steve_N, aes(x = `Date and time`, 
                               y = `Nitrate plus nitrite as mg-N/L`, 
                               color = "Downstream"), show.legend = TRUE, size = 1) +
  geom_point(data = eric_N, aes(x = `Date and time`, 
                              y = `Nitrate plus nitrite as mg-N/L`, 
                              color = "Discharge point"), show.legend = TRUE, size = 1) +
  geom_point(data = desoto, aes(x = dateTime, 
                                y = nitrateNitrite, color = "Far downstream"), 
                            show.legend = TRUE, size = 1) +
  coord_cartesian(xlim = c(pullBegin, pullEnd), ylim = c(0, 25), expand = TRUE) +
  labs(y = "Nitrate plus nitrite [mg-N/L]", x = "Date", title = "", color = "Legend") +
  theme_classic() +
  theme(legend.position = "right", legend.direction = "vertical") +
  scale_color_manual(values=wes_palette(n=4, name="Darjeeling"))

nitrataxMergedPlot
```

## Individual raw plots: DO, Temp, N Plots  

Function setup for individual, simple plots for each site  
```{r simplePlotFunction, include=FALSE}
# Function name:
      # simplePlot
# Function description:
      # function to output a simple plot from specified input variables
# Input variable definitions:
      # dataset = the time series dataset from which the plot will be generated, dataframe
      # xAxis = variable to be plotted on the x axis, POSIXct format
      # yAxis = variable to be plotted on the y axis, numeric
      # plotBegin = date that plot should start, POSIXct format
      # plotEnd = date that plot should end, POSIXct format
      # yMin = minimum value of y axis, numeric
      # yMax = maximum value of y axis, numeric
      # yLabel = desired label of y axis, character string
      # xLabel = desired label of x axis, character string
      # title = desired title of plot, character string
# Outputs:
      # time series plot

simplePlot <- function(dataset, xAxis, yAxis, plotBegin, plotEnd, yMin, yMax, xLabel, yLabel, title){
  ggplot(NULL) + 
    geom_point(data = dataset, aes(x = xAxis, y = yAxis, color = title), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(plotBegin, plotEnd), 
                    ylim = c(yMin, yMax)) +
    labs(y = yLabel, x = xLabel, title = title) +
    theme_classic()
}
```

### Bowersock (Upstream)  

```{r bowersockPlots, echo=FALSE, warning=FALSE, fig.height=3, fig.width=10}
bowersockPlot_N <- simplePlot(dataset = bowersock_N, 
                              xAxis = bowersock_N$`Date and time`, 
                              yAxis = bowersock_N$`Nitrate plus nitrite as mg-N/L`,
                              plotBegin = pullBegin, plotEnd = pullEnd, xLabel = "Date",
                              yMin = 0, yMax = 1.5, 
                              yLabel = "Nitrate plus nitrite [mg-N/L]",
                              title = "Upstream") +
  scale_color_manual(values=wes_palette(n=5, name="Darjeeling")[1])

bowersockPlot_N
```

### Farmland Logs (Pipe outflow)  

```{r FarmlandPumpLogsPlots, echo=FALSE, warning=FALSE, fig.height=3, fig.width=10}
LogDateStart <- min(FarmlandPumpingLogs$Date) 
LogDateEnd <- max(FarmlandPumpingLogs$Date)

pullBegin1 <- ymd(pullBegin)
pullEnd1 <- ymd(pullEnd)

FarmlandPump_DrainageDitch_NitratePlot <- ggplot(data = FarmlandPumpingLogs, 
                                                 aes(Date, Downstream_1625RdDitch_NitrateNitrite_mgN.L)) + 
    geom_line(show.legend = FALSE, size = 1, 
              color = wes_palette(n=5, name="Royal2")[5]) +
    coord_cartesian(xlim = c(LogDateStart, LogDateEnd), ylim = c(0, 700)) +
    labs(y = "Nitrate plus nitrite [mg-N/L]", x = "Date", 
         title = "Farmland pipe outflow") +
    theme_classic() + scale_color_manual(values=wes_palette(n=5, name="Darjeeling")[1])

FarmlandPump_DrainageDitch_NitratePlot

FarmlandPump_DrainageDitch_NitratePlot_zoom <- ggplot(data = FarmlandPumpingLogs, 
                                                 aes(Date, Downstream_1625RdDitch_NitrateNitrite_mgN.L)) + 
    geom_point(show.legend = FALSE, size = 1, 
              color = wes_palette(n=5, name="Royal2")[5]) +
    coord_cartesian(xlim = c(pullBegin1, pullEnd1), ylim = c(0, 700)) +
    labs(y = "Nitrate plus nitrite [mg-N/L]", x = "Date", 
         title = "Farmland pipe outflow") +
    theme_classic() + scale_color_manual(values=wes_palette(n=5, name="Darjeeling")[1])

FarmlandPump_DrainageDitch_NitratePlot_zoom
```

### Eric (Discharge point)  

```{r ericPlots, echo=FALSE, warning=FALSE}
ericPlot_N <- simplePlot(dataset = eric_N, 
                         xAxis = eric_N$`Date and time`,
                         yAxis = eric_N$`Nitrate plus nitrite as mg-N/L`,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                         yMin = 0, yMax = 20, yLabel = "Nitrate plus nitrite [mg-N/L]",
                         title = "Discharge point") +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[1])

ericPlot_DO <- simplePlot(dataset = eric_DO, 
                         xAxis = eric_DO$time_CST,
                         yAxis = eric_DO$DO_mgL,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                         yMin = 0, yMax = 20, yLabel = "Dissolved oxygen [mg/L]",
                         title = "Discharge point") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[2])

ericPlot_temp <- simplePlot(dataset = eric_DO, 
                         xAxis = eric_DO$time_CST,
                         yAxis = eric_DO$temp_C,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = "Date",
                         yMin = -5, yMax = 25, yLabel = "Temperature [C]",
                         title = "Discharge point") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[3])

grid.arrange(ericPlot_N, ericPlot_DO, ericPlot_temp, ncol = 1, nrow = 3)
```

### Steve (5 km Downstream)  

```{r stevePlots, echo=FALSE, warning=FALSE}
# Steve (downstream)
stevePlot_N <- simplePlot(dataset = steve_N, 
                          xAxis = steve_N$`Date and time`,
                          yAxis = steve_N$`Nitrate plus nitrite as mg-N/L`,
                          plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                          yMin = 0, yMax = 1.5, yLabel = "Nitrate plus nitrite [mg-N/L]",
                          title = "Downstream (5 km)") + 
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[1])

stevePlot_DO <- simplePlot(dataset = steve_DO, 
                         xAxis = steve_DO$time_CST,
                         yAxis = steve_DO$DO_mgL,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                         yMin = 0, yMax = 20, yLabel = "Dissolved oxygen [mg/L]",
                         title = "Downstream (5 km)") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[2])

stevePlot_temp <- ericPlot_temp <- simplePlot(dataset = steve_DO, 
                         xAxis = steve_DO$time_CST,
                         yAxis = steve_DO$temp_C,
                         plotBegin = pullBegin, plotEnd = pullEnd, xLabel = "Date",
                         yMin = -5, yMax = 25, yLabel = "Temperature [C]",
                         title = "Downstream (5 km)") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[3])

grid.arrange(stevePlot_N, stevePlot_DO, stevePlot_temp, ncol = 1, nrow = 3)
```

### Desoto (30 km Downstream)  

```{r desotoPlots, echo=FALSE, warning=FALSE}
desotoPlot_N <- simplePlot(dataset = desoto, 
                           xAxis = desoto$dateTime,
                           yAxis = desoto$nitrateNitrite,
                           plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                           yMin = 0, yMax = 1.5, yLabel = "Nitrate plus nitrite [mg-N/L]",
                           title = "Far downstream (30 km)") +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[1])

desotoPlot_DO <- simplePlot(dataset = desoto, 
                           xAxis = desoto$dateTime,
                           yAxis = desoto$DO_Inst,
                           plotBegin = pullBegin, plotEnd = pullEnd, xLabel = NULL,
                           yMin = 0, yMax = 20, yLabel = "Dissolved oxygen [mg/L]",
                           title = "Far downstream (30 km)") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[2])

desotoPlot_temp <- simplePlot(dataset = desoto, 
                              xAxis = desoto$dateTime,
                              yAxis = desoto$Wtemp_Inst,
                              plotBegin = pullBegin, plotEnd = pullEnd, xLabel = "Date",
                              yMin = -5, yMax = 25, yLabel = "Temperature [C]",
                              title = "Far downstream (30 km)") +
  theme(plot.title = element_blank()) +
  scale_color_manual(values=wes_palette(n=3, name="Darjeeling")[3])

grid.arrange(desotoPlot_N, desotoPlot_DO, desotoPlot_temp, ncol = 1, nrow = 3)
```

## Stacked raw N data plot (include in talk)  

```{r StackedNPlot, fig.height=9, fig.width=9}
colorBlindPalette <- c("#56B4E9", "#E69F00", "#CC79A7", "#000000")

stackedNPlot <- 
  grid.arrange(
    bowersockPlot_N +
      coord_cartesian(xlim = c(pullBegin, pullEnd),
                      ylim = c(0, 1.5)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
      scale_color_manual(values = colorBlindPalette[1]),
  
    ericPlot_N +
      coord_cartesian(xlim = c(pullBegin, pullEnd),
                      ylim = c(0, 25)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
      scale_color_manual(values = colorBlindPalette[2]),
  
    stevePlot_N +
      coord_cartesian(xlim = c(pullBegin, pullEnd),
                      ylim = c(0, 1.5)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
      scale_color_manual(values = colorBlindPalette[3]),
  
    desotoPlot_N +
      coord_cartesian(xlim = c(pullBegin, pullEnd),
                      ylim = c(0, 1.5)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14)) +
      scale_color_manual(values = colorBlindPalette[4]),
  
    nrow = 4,
    ncol = 1
)

ggsave(filename = "StackedNPlot.png", plot = stackedNPlot, dpi = 500)
```

## Combined temperature plot
```{r comboTemp}

```

## Time period plots  

### Period 1:  Feb 3-6  

```{r Period1Plot, include=FALSE, fig.height=9, fig.width=5}
Period1Start <- mdy_hms("02-03-2018 12:00:00")
Period1End <- mdy_hms("02-06-2018 12:00:00")

# Grid arrange bowersock for time period #1
bowersockPlot_Period1 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,1.25)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #1
ericPlot_Period1 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,1.25)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,30)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #1
stevePlot_Period1 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,1.25)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,30)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #1
desotoPlot_Period1 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,1.25)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,30)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period1Start,Period1End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)
```

```{r Period1ComboPlot, echo=FALSE, fig.height=9, fig.width=15}
grid.arrange(bowersockPlot_Period1,
             ericPlot_Period1,
             stevePlot_Period1,
             desotoPlot_Period1,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 1: Feb 3-6"
)
```

### Period 2:  Feb 20-22  

```{r Period2Plot, include=FALSE, fig.height=9, fig.width=5}
Period2Start <- mdy_hms("02-20-2018 12:00:00")
Period2End <- mdy_hms("02-22-2018 12:00:00")

# Grid arrange bowersock for time period #2
bowersockPlot_Period2 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,1.5)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #2
ericPlot_Period2 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,7)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,30)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #2
stevePlot_Period2 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,1.5)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,30)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #2
desotoPlot_Period2 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,1.5)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,30)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period2Start,Period2End),
                    ylim = c(0,20)),
  ncol = 1,
  nrow = 3
)
```

```{r Period2ComboPlot, echo=FALSE, fig.height=9, fig.width=15}
grid.arrange(bowersockPlot_Period2,
             ericPlot_Period2,
             stevePlot_Period2,
             desotoPlot_Period2,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 2: Feb 20-22"
)
```

### Period 3:  Mar 22-25  

```{r Period3Plot, include=FALSE, fig.height=9, fig.width=5}
Period3Start <- mdy_hms("03-22-2018 12:00:00")
Period3End <- mdy_hms("03-25-2018 12:00:00")

# Grid arrange bowersock for time period #3
bowersockPlot_Period3 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #3
ericPlot_Period3 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #3
stevePlot_Period3 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #3
desotoPlot_Period3 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period3Start,Period3End)),
  ncol = 1,
  nrow = 3
)
```

```{r Period3ComboPlot, echo=FALSE, fig.height=9, fig.width=15}
grid.arrange(bowersockPlot_Period3,
             ericPlot_Period3,
             stevePlot_Period3,
             desotoPlot_Period3,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 3: March 22-25"
)
```

### Period 4:  Apr 3-6  

```{r Period4Plot, include=FALSE, fig.height=9, fig.width=5}
Period4Start <- mdy_hms("04-03-2018 12:00:00")
Period4End <- mdy_hms("04-06-2018 12:00:00")

# Grid arrange bowersock for time period #4
bowersockPlot_Period4 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #4
ericPlot_Period4 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #4
stevePlot_Period4 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #4
desotoPlot_Period4 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period4Start,Period4End)),
  ncol = 1,
  nrow = 3
)
```

```{r Period4ComboPlot, echo=FALSE, fig.height=9, fig.width=15}
grid.arrange(bowersockPlot_Period4,
             ericPlot_Period4,
             stevePlot_Period4,
             desotoPlot_Period4,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 4: April 3-6"
)
```

### Period 5:  Apr 11-13  

```{r Period5Plot, include=FALSE, fig.height=9, fig.width=5}
Period5Start <- mdy_hms("04-11-2018 12:00:00")
Period5End <- mdy_hms("04-13-2018 12:00:00")

# Grid arrange bowersock for time period #5
bowersockPlot_Period5 <- grid.arrange(
  bowersockPlot_N +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ggplot(NULL),
  ggplot(NULL),
  ncol = 1,
  nrow = 3
)

# Grid arrange Eric for time period #5
ericPlot_Period5 <- grid.arrange(
  ericPlot_N +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ericPlot_DO +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ericPlot_temp +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Steve for time period #5
stevePlot_Period5 <- grid.arrange(
  stevePlot_N +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  stevePlot_DO +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  stevePlot_temp +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ncol = 1,
  nrow = 3
)

# Grid arrange Desoto for time period #5
desotoPlot_Period5 <- grid.arrange(
  desotoPlot_N +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  desotoPlot_DO +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  desotoPlot_temp +
    coord_cartesian(xlim = c(Period5Start,Period5End)),
  ncol = 1,
  nrow = 3
)
```

```{r Period5ComboPlot, echo=FALSE, fig.height=9, fig.width=15}
grid.arrange(bowersockPlot_Period5,
             ericPlot_Period5,
             stevePlot_Period5,
             desotoPlot_Period5,
             ncol = 4,
             nrow = 1,
             widths = c(1,1,1,1),
             top = "Time Period 4: April 3-6"
)
```

## Diel cutaway plots for SFS powerpoint  
```{r dielCutaway, fig.height=2, fig.width=2}
# diel cutaway plot for powerpoint
ericPlot_N_dielCutaway <- 
  ericPlot_N +
      coord_cartesian(xlim = c(Period3Start,Period3End)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
        scale_color_manual(values = colorBlindPalette[2])

ggsave(filename = "Site2_dielCutaway.png", plot = ericPlot_N_dielCutaway, dpi = 500,
       width = 2, height = 2, units = "in")

desotoPlot_N_dielCutaway <- 
  desotoPlot_N +
      coord_cartesian(xlim = c(Period3Start,Period3End)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
        scale_color_manual(values = colorBlindPalette[4])

ggsave(filename = "Site4_dielCutaway.png", plot = desotoPlot_N_dielCutaway, dpi = 500,
       width = 2, height = 2, units = "in")

stevePlot_N_dielCutaway <- 
  stevePlot_N +
      coord_cartesian(xlim = c(Period4Start,Period4End),
                      ylim = c(0,1.5)) +
      xlab(NULL) +
      ylab(NULL) +
      ggtitle(NULL) +
      theme(axis.text = element_text(size = 14),
            axis.text.x = element_blank()) +
        scale_color_manual(values = colorBlindPalette[3])

ggsave(filename = "Site3_dielCutaway.png", plot = stevePlot_N_dielCutaway, dpi = 500,
       width = 2, height = 2, units = "in")

```

## PAR plot
```{r PARplotting, fig.height=3, fig.width=9}
# calculate sum of PAR mean values
PAR$PARMean_sum <- cumsum(PAR$PARMean)

# convert PAR units (from umol m^-2 s^-1 to mol m^-2 d^-1)
umolm2s_to_molm2d <- function(umol_m2_s){
  mol_m2_s <- umol_m2_s*1.0E-6
  mol_m2_d <- mol_m2_s*86400
  return(mol_m2_d)
}

PAR$PARMean_sum_molm2d <- umolm2s_to_molm2d(PAR$PARMean_sum)

#convert PAR units (from umol m^-2 s^-1 to mol m^-2 s^-1)
umol_mol <- function(umol){
  mol <- umol*1.0E-6
  return(mol)
}

PAR$PARMean_sum_molm2s <- umol_mol(PAR$PARMean_sum)

#ok our raw values are on the same magnitide as the Lupon paper, but the converted values are not similar at all, wth

PAR_rawPlot <- 
  ggplot(NULL) + 
    geom_line(data = PAR, aes(x = startDateTime, y = PARMean), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(pullBegin, pullEnd)) +
    labs(y = "PAR, 
         umol m^-2 s^-1", 
         x = "Date") +
    theme_classic() +
    theme(axis.text = element_text(size = 14),
          axis.title = element_text(size = 14))

PAR_sumPlot <- 
  ggplot(NULL) + 
    geom_area(data = PAR, aes(x = startDateTime, y = PARMean_sum), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(pullBegin, pullEnd)) +
    labs(y = "Sum PAR, 
         umol m^-2 s^-1", 
         x = "Date") +
    theme_classic() +
    theme(axis.text = element_text(size = 14),
          axis.title = element_text(size = 14))

PAR_sumPlot_convertunits_molday <- 
  ggplot(NULL) + 
    geom_area(data = PAR, aes(x = startDateTime, y = PARMean_sum_molm2d), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(pullBegin, pullEnd)) +
    labs(y = "Sum PAR, 
         mol m^-2 d^-1", 
         x = "Date") +
    theme_classic() +
    theme(axis.text = element_text(size = 14),
          axis.title = element_text(size = 14))

PAR_sumPlot_convertunits_mol <- 
  ggplot(NULL) + 
    geom_area(data = PAR, aes(x = startDateTime, y = PARMean_sum_molm2s), 
               show.legend = FALSE, size = 1) +
    coord_cartesian(xlim = c(pullBegin, pullEnd)) +
    labs(y = "Sum PAR, 
         mol m^-2 s^-1", 
         x = "Date") +
    theme_classic() +
    theme(axis.text = element_text(size = 14),
          axis.title = element_text(size = 14))

PAR_rawPlot
PAR_sumPlot
PAR_sumPlot_convertunits_mol
PAR_sumPlot_convertunits_molday

ggsave(filename = "PAR_rawPlot.png", plot = PAR_rawPlot, dpi = 500,
       width = 10, height = 3, units = "in")
ggsave(filename = "PAR_sumPlot.png", plot = PAR_sumPlot, dpi = 500,
       width = 10, height = 3)
ggsave(filename = "PAR_sumPlot_molm2sec.png", plot = PAR_sumPlot_convertunits_mol, dpi = 500,
       width = 10, height = 3)
ggsave(filename = "PAR_sumPlot_molm2day.png", plot = PAR_sumPlot_convertunits_molday, dpi = 500,
       width = 10, height = 3)
```

# Water Balance  

## Computation  

```{r waterBalanceComputation, include=TRUE}
#subset data frames
desoto_sub <- data.frame(desoto$dateTime, desoto$Flow_Inst)
names(desoto_sub) <- c("dateTime", "Flow_Inst")
desoto_sub$dateTime <- ymd_hms(desoto_sub$dateTime)

lawrence_sub <- data.frame(lawrence$dateTime, lawrence$Flow_Inst)
names(lawrence_sub) <- c("dateTime", "Flow_Inst")
lawrence_sub$dateTime <- ymd_hms(lawrence_sub$dateTime)

# combine data frames
waterBal <- merge(desoto_sub, lawrence_sub, 
                  by = "dateTime", suffixes = c(".desoto", ".lawrence"))

#calculate difference between downstream and upstream gauge (balance = downstream discharge - upstream)
waterBal$difference <- waterBal$Flow_Inst.desoto - waterBal$Flow_Inst.lawrence
```

## Plotting  

```{r waterBalancePlotting, echo=FALSE, fig.height=3, fig.width=10, warning=FALSE}
# plotting flow at upstream and downstream locations on same time series graph
ggplot() +
  geom_line(data = desoto, aes(x = dateTime, y = Flow_Inst, color = "Desoto")) +
  geom_line(data = lawrence, aes(x = dateTime, y = Flow_Inst, color = "Lawrence"))

# plot the water balance graph centered on 0: 
      # positive values = gaining stream
      # negative values = losing stream
waterBal_plot <- ggplot() +
  geom_line(data = waterBal, 
            aes(x = dateTime, y = difference, color = "difference"),
            show.legend = FALSE, 
            color = colorBlindPalette[4]) +
  geom_hline(aes(yintercept = mean(na.omit(waterBal$difference))),
             color = "grey",
             linetype = "solid") +
  coord_cartesian(xlim = c(pullBegin, pullEnd), 
                  ylim = c(-50, 50)) +
  labs(y = "Difference between 
downstream and 
upstream flow, m3/s",
       x = "Date", 
       title = "Water balance of study reach") +
  theme_classic() +
  ggtitle(NULL) +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 14))

ggsave(filename = "waterBal_plot.png", plot = waterBal_plot, dpi = 500,
       width = 10, height = 3, units = "in")
```

***  

# Metabolism modeling

```{r MetabolismSetup}
#need: convert to solar time, DO saturation, depth of site, light
metab_inputs("mle", "data")

# start with desoto
desoto_longitude <- -94.964616
PAR$dateTime_solar <- calc_solar_time(PAR$startDateTime, longitude = desoto_longitude)
desoto$dateTime_solar <- calc_solar_time(desoto$dateTime, longitude = desoto_longitude)

sum(PAR$dateTime_solar==desoto$dateTime_solar)

# estimate stream depth from discharge data
  # using d = c*Q^f Leopold and Maddock 1953
  # default values for c and f as suggested in Raymond et al 2012
      # c = 0.409 m, f = 0.294 **verify if these are representative of Kaw

desoto$depth <- calc_depth(desoto$Flow_Inst)
  # this gives us close the the GH readings for depth

# fitting a bayesian model (better for multiple days of data b/c it can pool k600 values)
model_name <- mm_name(type = "bayes", pool_K600 = "none",
                      err_obs_iid = TRUE, err_proc_iid = TRUE)
bayes_specs <- specs(model_name)
bayes_specs # displays specifications of model

metab_inputs("bayes", "data") # list of required inputs

#assemble data frame of data needed for metabolism model
desoto_MetabData <- merge.data.frame(desoto, PAR, 
                                     by = intersect(names(desoto), names(PAR)))
desoto_MetabData <- desoto_MetabData[-c(2:4, 6, 8, 10, 12, 14:17, 19, 21:23)]

# comparison between using gage height and estimated depth
# using USGS measured gage height
desoto_MetabData_GH <- desoto_MetabData[-7]
names(desoto_MetabData_GH) <- c("solar.time", "temp.water", "discharge",
                                "depth", "DO.obs", "DO.sat", "light")
desoto_MetabData_GH <- desoto_MetabData_GH[-3]
#metab_bayes(specs = bayes_specs, data = desoto_MetabData_GH)


# using calculated depth
desoto_MetabData_calcDepth <- desoto_MetabData[-4]
names(desoto_MetabData_calcDepth) <- c("solar.time", "temp.water", "discharge",
                                       "DO.obs", "DO.sat", "depth", "light")

 
```

```{r leafletmaps}
map <- leaflet()
map <- addTiles(map)
GPS <- read.csv(file = "KansasR_Nitratax_GPS.csv", header = TRUE)

map <- addMarkers(map = map, 
                  lng = GPS$Longitude, lat = GPS$Latitude, 
                  popup = c("Upstream", "5km Downstream", 
                            "Discharge point", "30km Downstream"))
map <- addProviderTiles(map = map, providers$MtbMap)
map <- addProviderTiles(map = map, providers$Stamen.TonerLite)
map
names(providers)
```

