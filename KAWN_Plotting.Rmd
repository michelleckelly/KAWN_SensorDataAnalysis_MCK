---
title: "Kaw N plotting"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r Setup}
library(lubridate)
library(ggplot2)
library(dplyr)
```

```{r Load data}
# Sensor data

# N mass balance data
massbal <- read.csv("./Outputs/NMassBalance.csv")
massbal$date <- lubridate::ymd(massbal$date)

# Metabolism results
metab_eric <- readRDS("./Outputs/MetabResults_Eric.RData")$predictions
metab_steve <- readRDS("./Outputs/MetabResults_Steve.RData")$predictions
metab_desoto <- readRDS("./Outputs/MetabResults_Desoto.RData")$predictions
names(metab_desoto)[2:10] <- paste0(names(metab_desoto)[2:10], ".desoto")
metab <- dplyr::full_join(metab_eric, metab_steve, by = "date", 
                          suffix = c(".eric", ".steve")) %>%
  dplyr::full_join(., metab_desoto, by = "date")

# Edits that need to happen: taking out dates that have bad data
# For eric:
# 2018-02-20 thru 2018-02-23 sensor burial
# 2018-03-06 thru 2018-03-12 sensor burial
# 2018-04-01 thru 2018-04-04 sensor burial
# 2018-04-14 thru 2018-04-17 sensor burial
# 2018-04-25 thru 2018-04-27 sensor burial
# Steve:
# 2018-02-01 thru 2018-02-10 N sensor not yet deployed
# 2018-03-10 thru 2018-03-22 N sensor burial

# Nitrate uptake results
# HAVE bad dates removed
uptake <- readRDS("./Outputs/NitrateUptakeResults_Eqn2.rds")
```

```{r Join data for comparison plots}
# See the uptake analysis script for some of this
```

```{r Fig 1: Mapping}
```

```{r Fig 2: Metabolism and N supply vs time}
# Metbolism plot
ggplot(data = metab, aes(x = date)) +
  # Eric
  #geom_line(aes(y = GPP.eric, color = "Discharge")) +
  geom_ribbon(aes(ymin = GPP.lower.eric, ymax = GPP.upper.eric, fill = "Discharge"), alpha = 0.15) +
  geom_point(aes(y = GPP.eric, color = "Discharge")) +
  #geom_line(aes(y = ER.eric, color = "Discharge")) +
  #geom_point(aes(y = ER.eric, color = "Discharge"), shape = 21, fill = "white") +
  # Steve
  geom_ribbon(aes(ymin = GPP.lower.steve, ymax = GPP.upper.steve, fill = "Downstream"), alpha = 0.15) +
  #geom_line(aes(y = GPP.steve, color = "Downstream")) +
  geom_point(aes(y = GPP.steve, color = "Downstream")) +
  #geom_line(aes(y = ER.steve, color = "Downstream")) +
  #geom_point(aes(y = ER.steve, color = "Downstream"), shape = 21, fill = "white") +
  # Desoto
  geom_ribbon(aes(ymin = GPP.lower.desoto, ymax = GPP.upper.desoto, fill = "Desoto"), alpha = 0.15) +
  #geom_line(aes(y = GPP.desoto, color = "Desoto")) +
  geom_point(aes(y = GPP.desoto, color = "Desoto")) +
  #geom_line(aes(y = ER.desoto, color = "ER")) +
  #geom_point(aes(y = ER.desoto, color = "ER")) +
  # Axis labels
  labs(x = NULL, y = bquote(O[2] ~ m^-2 ~ d^-1 ~ "(g)")) +
  # Scaling
  scale_x_date(limits = c(as.Date("2018-02-01"), as.Date("2018-05-01")), 
               date_breaks = "2 weeks", date_labels = "%e %b") +
  # Line at y = 0
  #geom_line(aes(y = 0), color = "black") +
  # Theme adjustments
  theme_classic() +
  scale_color_manual(values = c("Discharge" = "#FF0000", 
                                "Downstream" = "#23baaf", "Desoto" = "#F2AD00"),
                     breaks = c("Discharge", "Downstream", "Desoto")) +
    scale_fill_manual(values = c("Discharge" = "#FF0000", 
                                 "Downstream" = "#23baaf", "Desoto" = "#F2AD00"),
                     breaks = c("Discharge", "Downstream", "Desoto")) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "bottom", legend.direction = "horizontal")

# N supply plot

# Plot of daily average nitrate load, calculated 
# as daily average nitrate concentration * daily average
# flow

ggplot(data = massbal, aes(x = date)) +
  # Upstream (Bowersock)
  geom_line(aes(y = NitrateLoad.bowersock_kgNday, color = "Upstream")) +
  geom_point(aes(y = NitrateLoad.bowersock_kgNday, color = "Upstream")) +
  # Bowersock: BDL designation
  geom_point(data = massbal[massbal$Nitrate.bowersock_mgNL < 0.1,],
             aes(y = NitrateLoad.bowersock_kgNday), shape = 21, fill = "white") +
  # Discharge (Eric)
  geom_line(aes(y = NitrateLoad.eric_kgNday, color = "Discharge")) +
  geom_point(aes(y = NitrateLoad.eric_kgNday, color = "Discharge")) +
  # Desoto
  geom_line(aes(y = NitrateLoad.desoto_kgNday, color = "Desoto")) +
  geom_point(aes(y = NitrateLoad.desoto_kgNday, color = "Desoto")) +
  # Downstream (Steve)
  geom_line(aes(y = NitrateLoad.steve_kgNday, color = "Downstream")) +
  geom_point(aes(y = NitrateLoad.steve_kgNday, color = "Downstream")) +
  #
  # Vertical line at 1-Apr-18
  geom_vline(aes(xintercept = as_date("2018-04-01")), linetype = 2) +
  # axis and color scales
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e" ) + 
  scale_y_log10()+
  scale_color_manual(values = c("Upstream" = "#000000", "Discharge" = "#FF0000", 
                                 "Downstream" = "#23baaf", "Desoto" = "#F2AD00"),
                     breaks = c("Upstream", "Discharge", "Downstream", "Desoto"),
                     name = "Site") +
  scale_shape_manual(values = 21) +
  # axis labels
  xlab(NULL) + 
  ylab(expression(NO[3]^{"-"}-N ~~ "Load  (kg" ~~ day^{-1} * ")"))+
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "bottom", legend.title = element_blank())
```

```{Fig 3: Uptake vs time plotting}
ggplot(data = uptake, aes(x = Date)) +
  # Discharge (Eric)
  geom_smooth(data = subset(uptake, ReleaseStatus == "During"), 
              aes(y = UaNO3_gNm2day.eric/1000, color = "Discharge"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_smooth(data = subset(uptake, ReleaseStatus == "After"), 
              aes(y = UaNO3_gNm2day.eric/1000, color = "Discharge"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_point(aes(y = UaNO3_gNm2day.eric/1000, color = "Discharge")) +
  # Steve
  geom_smooth(data = subset(uptake, ReleaseStatus == "During"), 
              aes(y = UaNO3_gNm2day.steve/1000, color = "Downstream"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_smooth(data = subset(uptake, ReleaseStatus == "After"), 
              aes(y = UaNO3_gNm2day.steve/1000, color = "Downstream"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_point(aes(y = UaNO3_gNm2day.steve/1000, color = "Downstream")) +
  # Desoto
  geom_smooth(data = subset(uptake, ReleaseStatus == "During"), 
              aes(y = UaNO3_gNm2day.desoto/1000, color = "Desoto"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_smooth(data = subset(uptake, ReleaseStatus == "After"), 
              aes(y = UaNO3_gNm2day.desoto/1000, color = "Desoto"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_point(aes(y = UaNO3_gNm2day.desoto/1000, color = "Desoto")) +
  # Horizontal line at 1 April, pump shutoff date
  geom_vline(aes(xintercept = as_date("2018-04-01")), linetype = 2) +
  # Axis scales
  scale_y_log10() +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e") + 
  # Color scales
  scale_color_manual(values = c("Upstream" = "#000000", "Discharge" = "#FF0000", 
                                 "Downstream" = "#23baaf", "Desoto" = "#F2AD00"),
                     limits = c("Discharge", "Downstream", "Desoto")) +
  # axis labels
  xlab(NULL) + 
  ylab(expression(Ua-NO[3]^{"-"} ~~ "(kg-N" ~~ m^{-2} ~ day^{-1} * ")")) +
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "bottom", legend.title = element_blank())

# Save plot
ggsave("./Plots/Uptake_time.png", height = 5, width = 6, units = "in")
```
