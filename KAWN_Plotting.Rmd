---
title: "Kaw N plotting"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r Setup}
library(lubridate)
library(ggplot2)
library(dplyr)
library(ggmap) # Mapping libraries
library(maps)
library(mapdata)
library(ggpubr)
library(gridExtra)
```

```{r Load data}
#### Site location data ###
coords <- read.csv("./Data/GPScoordinates_12Nov18.csv", 
                   stringsAsFactors = FALSE)
# Rename site names
coords$SiteNickname[coords$SiteNickname == "Bowersock"] <- "S0"
coords$SiteNickname[coords$SiteNickname == "Eric"] <- "S1"
coords$SiteNickname[coords$SiteNickname == "Steve"] <- "S2"
coords$SiteNickname[coords$SiteNickname == "Desoto"] <- "S3"

### Sensor data ###
sensor_eric <- 
  read.csv("./Data/StreamPULSE_Downloaded/KS_KANSASREASTLAWRENCE_sensorData.csv")
sensor_steve <- 
  read.csv("./Data/StreamPULSE_Downloaded/KS_KANSASRFALLLEAF_sensorData.csv")
sensor_desoto <- 
  read.csv("./Data/StreamPULSE_Downloaded/KS_KANSASR_sensorData.csv")

# summarize sensor data: take daily averages & merge w/ metabolism
dailyavg <- function(sensor_data){
  # if sensor data has a "bad data" flag, set value to NA
  sensor_data$value[sensor_data$flagtype %in% c("Bad Data")] <- NA
  # reshape sensor data from long format to wide format
  sensor_data <- tidyr::spread(sensor_data, key = variable, value = value)
  # reformat datetime
  sensor_data$DateTime_UTC <- lubridate::ymd_hms(sensor_data$DateTime_UTC)
  # change time zone from UTC to central
  sensor_data$dateTime <- lubridate::with_tz(sensor_data$DateTime_UTC, 
                                             tzone = "America/Chicago")
  # sort data file and find daily averages
  sensor_data <- sensor_data %>%
    dplyr::group_by(date = lubridate::date(dateTime)) %>% 
    dplyr::summarise(Nitrate_mgL = mean(Nitrate_mgL, na.rm = TRUE),
                     Discharge_m3s = mean(Discharge_m3s, na.rm = TRUE),
                     DO_mgL = mean(DO_mgL, na.rm = TRUE),
                     Light_PAR = mean(Light_PAR, na.rm = TRUE),
                     WaterTemp_C = mean(WaterTemp_C, na.rm = TRUE))
  # Factorize release status
  sensor_data$ReleaseStatus <- NA
  sensor_data$ReleaseStatus[sensor_data$date < ymd("2018-04-01")] <- "During"
  sensor_data$ReleaseStatus[sensor_data$date >= ymd("2018-04-01")] <- "After"
  sensor_data$ReleaseStatus <- factor(sensor_data$ReleaseStatus, 
                                      levels = c("During", "After"))
  return(sensor_data)
}
sensor_eric <- dailyavg(sensor_eric)
sensor_steve <- dailyavg(sensor_steve)
sensor_desoto <- dailyavg(sensor_desoto)

### N mass balance data ###
massbal <- readRDS("./Outputs/NMassBalance.rds")
# bowersock load gets down to 0 which doesnt show up well on a log10 scaled 
# plot, so bump up to 20 for plotting
massbal$NitrateLoad.bowersock_gNday[massbal$date > ymd("2018-02-26")] <- 10000
massbal$Nitrate.bowersock_mgNL[massbal$date >= ymd("2018-02-26")] <- 0.1
massbal$Nitrate.bowersock_mgNL[massbal$date == ymd("2018-03-31")] <- 0
# Steve nitrate sensor burial
massbal$Nitrate.steve_mgNL[massbal$date >= ymd("2018-03-10") & 
                             massbal$date <= ymd("2018-03-26")] <- NA

### Metabolism results ###
metab_eric <- readRDS("./Outputs/MetabResults_Eric.RData")$predictions
metab_steve <- readRDS("./Outputs/MetabResults_Steve.RData")$predictions
metab_desoto <- readRDS("./Outputs/MetabResults_Desoto.RData")$predictions
names(metab_desoto)[2:10] <- paste0(names(metab_desoto)[2:10], ".desoto")
metab <- dplyr::full_join(metab_eric, metab_steve, by = "date", 
                          suffix = c(".eric", ".steve")) %>%
  dplyr::full_join(., metab_desoto, by = "date")
# Metabolism bad dates removal
# Eric
metab$GPP.eric[metab$date >= ymd("2018-02-20") & 
                 metab$date <= ymd("2018-02-24")] <- NA
metab$ER.eric[metab$date >= ymd("2018-02-20") & 
                 metab$date <= ymd("2018-02-24")] <- NA
metab$GPP.lower.eric[metab$date >= ymd("2018-02-20") & 
                       metab$date <= ymd("2018-02-24")] <- NA
metab$GPP.eric[metab$date >= ymd("2018-03-05") & 
                 metab$date <= ymd("2018-03-12")] <- NA
metab$ER.eric[metab$date >= ymd("2018-03-05") & 
                 metab$date <= ymd("2018-03-12")] <- NA
metab$GPP.lower.eric[metab$date >= ymd("2018-03-05") & 
                       metab$date <= ymd("2018-03-12")] <- NA
metab$GPP.eric[metab$date == ymd("2018-03-28")] <- NA #Uncaught sensor burial?
metab$ER.eric[metab$date == ymd("2018-03-28")] <- NA #Uncaught sensor burial?
metab$GPP.lower.eric[metab$date == ymd("2018-03-28")] <- NA 
metab$GPP.eric[metab$date > ymd("2018-04-01") & 
                 metab$date <= ymd("2018-04-05")] <- NA
metab$ER.eric[metab$date > ymd("2018-04-01") & 
                 metab$date <= ymd("2018-04-05")] <- NA
metab$GPP.lower.eric[metab$date > ymd("2018-04-01") & 
                       metab$date <= ymd("2018-04-05")] <- NA
metab$GPP.eric[metab$date >= ymd("2018-04-14") & 
                 metab$date < ymd("2018-04-17")] <- NA
metab$ER.eric[metab$date >= ymd("2018-04-14") & 
                 metab$date < ymd("2018-04-17")] <- NA
metab$GPP.lower.eric[metab$date >= ymd("2018-04-14") & 
                       metab$date < ymd("2018-04-17")] <- NA
metab$GPP.eric[metab$date >= ymd("2018-04-25") & 
                 metab$date <= ymd("2018-04-30")] <- NA
metab$ER.eric[metab$date >= ymd("2018-04-25") & 
                 metab$date <= ymd("2018-04-30")] <- NA
metab$GPP.lower.eric[metab$date >= ymd("2018-04-25") & 
                       metab$date <= ymd("2018-04-30")] <- NA
# Steve
#metab$GPP.steve[metab$date >= ymd("2018-02-01") & 
                 #metab$date <= ymd("2018-02-10")] # Double check this
# Likely dates but need double checking with O2 record:
metab$GPP.steve[metab$date >= ymd("2018-03-09") & 
                 metab$date <= ymd("2018-03-10")] <- NA # marked "bad data"
metab$GPP.lower.steve[metab$date >= ymd("2018-03-09") & 
                        metab$date <= ymd("2018-03-10")] <- NA
metab$GPP.steve[metab$date >= ymd("2018-03-30") & 
                 metab$date <= ymd("2018-04-09")] <- NA # No O2 data here 
# because I shut the sensor off accidentally
metab$GPP.lower.steve[metab$date >= ymd("2018-03-30") & 
                        metab$date <= ymd("2018-04-09")] <- NA
metab$GPP.steve[metab$date >= ymd("2018-04-20") & 
                 metab$date <= ymd("2018-05-01")] <- NA
metab$GPP.lower.steve[metab$date >= ymd("2018-04-20") & 
                        metab$date <= ymd("2018-05-01")] <- NA
metab$ER.steve[metab$date >= ymd("2018-03-09") & 
                 metab$date <= ymd("2018-03-10")] <- NA # marked "bad data"
metab$ER.lower.steve[metab$date >= ymd("2018-03-09") & 
                        metab$date <= ymd("2018-03-10")] <- NA
metab$ER.steve[metab$date >= ymd("2018-03-30") & 
                 metab$date <= ymd("2018-04-09")] <- NA # No O2 data here 
# because I shut the sensor off accidentally
metab$ER.lower.steve[metab$date >= ymd("2018-03-30") & 
                        metab$date <= ymd("2018-04-09")] <- NA
metab$ER.steve[metab$date >= ymd("2018-04-20") & 
                 metab$date <= ymd("2018-05-01")] <- NA
metab$ER.lower.steve[metab$date >= ymd("2018-04-20") & 
                        metab$date <= ymd("2018-05-01")] <- NA

sensor_eric <- dplyr::full_join(sensor_eric, metab_eric, by = "date")
sensor_steve <- dplyr::full_join(sensor_steve, metab_steve, by = "date")
sensor_desoto <- dplyr::full_join(sensor_desoto, metab_desoto, by = "date")

# Edits that need to happen: taking out dates that have bad data
# For eric:
# 2018-02-20 thru 2018-02-23 sensor burial
# 2018-03-06 thru 2018-03-12 sensor burial
# 2018-04-01 thru 2018-04-04 sensor burial
# 2018-04-14 thru 2018-04-17 sensor burial
# 2018-04-25 thru 2018-04-27 sensor burial
# Steve:
# 2018-02-01 thru 2018-02-10 N sensor not yet deployed
# 2018-03-10 thru 2018-03-22 N sensor burial

### Nitrate uptake results ###
# HAVE bad dates removed
uptake <- readRDS("./Outputs/NitrateUptakeResults_Eqn1.rds")
uptake$UaNO3_gNm2day.steve[uptake$Date == "2018-03-01"] <- NA # affected by rapid 
#discharge change, U calculation overestimate
uptake$UaNO3_gNm2day.steve[uptake$Date == "2018-03-09"] <- NA # affected by sensor 
#burial that started around 03-10

### Reshape metab data ########################################################
# Factorize release status
metab$ReleaseStatus <- NA
metab$ReleaseStatus[metab$date < ymd("2018-04-01")] <- "During"
metab$ReleaseStatus[metab$date >= ymd("2018-04-01")] <- "After"
metab$ReleaseStatus <- factor(metab$ReleaseStatus, 
                              levels = c("During", "After"))
# Adjust from wide to long format
metab.long <- tidyr::gather(metab[c(-3:-4,-6:-10, -12:-13, -15:-19, -21:-22, 
                                    -24:-28)], key = site, value = value,
                            GPP.eric:ER.desoto)
# Factorize site and change labels
metab.long$site <- factor(metab.long$site)
# Initialize column to store metab model type (GPP or ER)
metab.long$model <- metab.long$site
# Rename factor levels
levels(metab.long$model)[levels(metab.long$site)=="GPP.eric"] <- "GPP"
levels(metab.long$site)[levels(metab.long$site)=="GPP.eric"] <- "S1"
levels(metab.long$model)[levels(metab.long$site)=="GPP.steve"] <- "GPP"
levels(metab.long$site)[levels(metab.long$site)=="GPP.steve"] <- "S2"
levels(metab.long$model)[levels(metab.long$site)=="GPP.desoto"] <- "GPP"
levels(metab.long$site)[levels(metab.long$site)=="GPP.desoto"] <- "S3"
levels(metab.long$model)[levels(metab.long$site)=="ER.eric"] <- "ER"
levels(metab.long$site)[levels(metab.long$site)=="ER.eric"] <- "S1"
levels(metab.long$model)[levels(metab.long$site)=="ER.steve"] <- "ER"
levels(metab.long$site)[levels(metab.long$site)=="ER.steve"] <- "S2"
levels(metab.long$model)[levels(metab.long$site)=="ER.desoto"] <- "ER"
levels(metab.long$site)[levels(metab.long$site)=="ER.desoto"] <- "S3"
metab.long$model <- factor(metab.long$model, levels = c("GPP", "ER")) # Reorder
metab.long$site <- factor(metab.long$site, levels = c("S1", "S2", "S3"))

### Reshape uptake data ########################################################
# Factorize release status
uptake$ReleaseStatus <- factor(uptake$ReleaseStatus, 
                               levels = c("During", "After"))
# Adjust from wide to long format
uptake.long <- tidyr::gather(uptake[c(-2:-4, -6:-9, -11:-14, -16)], key = site, 
                             value = UaNO3_gNm2day,
                             UaNO3_gNm2day.eric:UaNO3_gNm2day.desoto)
supply.long <- tidyr::gather(uptake[c(-2:-5, -7:-10, -12:-15, -17)], key = site, 
                             value = NitrateSupply_gNm2day,
                             NitrateSupply_gNm2day.eric:NitrateSupply_gNm2day.desoto)
# Factorize site name
uptake.long$site <- factor(uptake.long$site, levels = c("UaNO3_gNm2day.eric", 
                                                        "UaNO3_gNm2day.steve", 
                                                        "UaNO3_gNm2day.desoto"))
levels(uptake.long$site)[levels(uptake.long$site)=="UaNO3_gNm2day.eric"] <- 
  "S1"
levels(uptake.long$site)[levels(uptake.long$site)=="UaNO3_gNm2day.steve"] <- 
  "S2"
levels(uptake.long$site)[levels(uptake.long$site)=="UaNO3_gNm2day.desoto"] <- 
  "S3"
supply.long$site <- factor(supply.long$site, 
                           levels = c("NitrateSupply_gNm2day.eric", 
                                      "NitrateSupply_gNm2day.steve", 
                                      "NitrateSupply_gNm2day.desoto"))
levels(supply.long$site)[levels(supply.long$site)==
                           "NitrateSupply_gNm2day.eric"] <- "S1"
levels(supply.long$site)[levels(supply.long$site)==
                           "NitrateSupply_gNm2day.steve"] <- "S2"
levels(supply.long$site)[levels(supply.long$site)==
                           "NitrateSupply_gNm2day.desoto"] <- "S3"

### Join data for comparison plotting ##########################################
# Merge uptake data and metabolism data
metab.long$Date <- metab.long$date
uptake.metab.long <- dplyr::full_join(metab.long, uptake.long, 
                                      by = c("Date", "site", "ReleaseStatus"))
uptake.metab.long$date <- NULL
uptake.metab.long <- subset(uptake.metab.long, Date < ymd("2018-05-01"))

# Merge uptake with N load
uptake.metab.mass.long <- dplyr::full_join(uptake.metab.long, supply.long, 
                                           by = c("Date", "site"))
# Subset dates
uptake.metab.mass.long <- subset(uptake.metab.mass.long, 
                                 uptake.metab.mass.long$Date < ymd("2018-05-01"))
uptake.metab.mass.long <- subset(uptake.metab.mass.long, 
                                 uptake.metab.mass.long$Date >= ymd("2018-02-01"))

# Load in Tank et al 2008 uptake meta-analysis
tank <- read.csv("./Data/Meta-analysis/Tank_2008_uptakedata.csv",
                 header = TRUE)
tank$NO3_Cb_mgNL <- tank$NO3_Cb_ugNL/1000

# Load in Hall et al 2016 metabolism meta-analysis
hall <- read.csv("./Data/Meta-analysis/Hall_2016_metabolismdata.csv", 
                 header = TRUE)
hall$q_m3s <- hall$q_Ls/1000
```

```{r Fig 1: Mapping}
# Pull country, state, county map data
state.map <- map_data("state")
kansas.map <- subset(state.map, region == "kansas")
counties.map <- subset(map_data("county"), region == "kansas")

# Pull rivers map data:
# Data provided by Esri, National Atlas of the United States and the United 
# States Geological Survey, accessed 26-Jan-19, ArcGIS "USA Rivers and Streams" 
# dataset www.arcgis.com
load(url("https://vrzkj25a871bpq7t1ugcgmn9-wpengine.netdna-ssl.com/wp-content/datasets/usa_rivers.RData"))
lines.rivers <- subset(lines.rivers, STATE %in% c("KS"))
ks_rivers <- fortify(lines.rivers)

# Plot state map
ggplot() +
  theme_nothing() +
  # Rivers
  #geom_path(data = ks_rivers, aes(x = long, y = lat, group = group), col = "#23baaf") +
  # Counties
  geom_polygon(data = counties.map, aes(x = long, y = lat, group = group), 
               fill = NA, color = "grey") +
  # State border
  geom_polygon(data = kansas.map, aes(x = long, y = lat, group = group), 
               fill = NA, color = "black") +
  # Location marker
  geom_point(data = coords, mapping = aes(x = long[5], y = lat[5]), 
             col = "black", shape = 0, size = 12, stroke = 2) +
  coord_fixed(1.3) +
  guides(fill = FALSE)
# Save plot
ggsave("./Plots/Map_state.png", height = 2, width = 3.5, units = "in")


# Plot local map
ggplot() +
  theme_nothing() +
  # Counties
  geom_polygon(data = counties.map, aes(x = long, y = lat, group = group), 
               fill = NA, color = "grey") +
  # Rivers
  geom_path(data = ks_rivers, aes(x = long, y = lat, group = group), size = 2,
            col = "#23baaf") +
  # Site location bubbles
  geom_point(data = coords, mapping = aes(x = long, y = lat), 
             col = "black", shape = 1, size = 5, stroke = 2) +
  # Site names
  geom_text(data = coords, aes(x = long, y = lat, label = SiteNickname), 
            nudge_y = 0.017, size = 7) +
  coord_fixed(1.3)  +
  coord_quickmap(xlim = c(-95.3, -94.9), ylim = c(38.83, 39.1)) +
  theme(panel.border = element_rect(color = "black", fill = NA))
# Save plot
ggsave("./Plots/Map_local.png", height = 5, width = 6, units = "in")


# Set up a map box using coordinates
coord.box <- make_bbox(lon = coords$long[5], lat = coords$lat[5])
googmap <- get_stamenmap(bbox = coord.box, zoom = 10, maptype = "watercolor")
ggmap(googmap)
```

```{r Fig 2: Metabolism vs ReleaseStatus statistical testing}
ggpubr::compare_means(value~ReleaseStatus, data = metab.long, 
                      group.by = c("model","site"))
```

```{r Fig 2: N load plot, N concentration plot, water temp plot}
# N load plot
ggplot(data = massbal, aes(x = date)) +
  # Upstream (Bowersock)
  geom_line(aes(y = NitrateLoad.bowersock_gNday/1000, color = "S0")) +
  geom_point(aes(y = NitrateLoad.bowersock_gNday/1000, color = "S0")) +
  # Bowersock: BDL designation
  geom_point(data = massbal[massbal$Nitrate.bowersock_mgNL <= 0.1,],
             aes(y = NitrateLoad.bowersock_gNday/1000), shape = 21, fill = "white") +
  # Discharge (Eric)
  geom_line(aes(y = NitrateLoad.eric_gNday/1000, color = "S1")) +
  geom_point(aes(y = NitrateLoad.eric_gNday/1000, color = "S1")) +
  # Downstream (Steve)
  geom_line(aes(y = NitrateLoad.steve_gNday/1000, color = "S2")) +
  geom_point(aes(y = NitrateLoad.steve_gNday/1000, color = "S2")) +
  # Desoto
  geom_line(aes(y = NitrateLoad.desoto_gNday/1000, color = "S3")) +
  geom_point(aes(y = NitrateLoad.desoto_gNday/1000, color = "S3")) +
  # Vertical line at 1-Apr-18
  geom_vline(aes(xintercept = as_date("2018-04-01")), linetype = 2) +
  # axis and color scales
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e" ) + 
  scale_y_log10()+
  scale_color_manual(values = c("S0" = "#000000", "S1" = "#FF0000", 
                                 "S2" = "#23baaf", "S3" = "#F2AD00"),
                     breaks = c("S0", "S1", "S2", "S3")) +
  scale_shape_manual(values = 21) +
  # axis labels
  xlab(NULL) + 
  ylab(expression(NO[3]^{"-"}-N ~~ "Load  (kg" ~~ day^{-1} * ")"))+
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "none", legend.title = element_blank())
ggsave("./Plots/NitrateLoad_time.png", height = 4, width = 6, units = "in")

# N concentration plot
a <- ggplot(data = massbal, aes(x = date)) +
  # Upstream (Bowersock)
  geom_line(aes(y = Nitrate.bowersock_mgNL, color = "S0")) +
  geom_point(aes(y = Nitrate.bowersock_mgNL, color = "S0")) +
  # Bowersock: BDL designation
  geom_point(data = massbal[massbal$Nitrate.bowersock_mgNL <= 0.1,],
             aes(y = Nitrate.bowersock_mgNL), shape = 21, fill = "white") +
  # Discharge (Eric)
  geom_line(aes(y = Nitrate.eric_mgNL, color = "S1")) +
  geom_point(aes(y = Nitrate.eric_mgNL, color = "S1")) +
  # Downstream (Steve)
  geom_line(aes(y = Nitrate.steve_mgNL, color = "S2")) +
  geom_point(aes(y = Nitrate.steve_mgNL, color = "S2")) +
  # Desoto
  geom_line(aes(y = Nitrate.desoto_mgNL, color = "S3")) +
  geom_point(aes(y = Nitrate.desoto_mgNL, color = "S3")) +
  # Vertical line at 1-Apr-18
  geom_vline(aes(xintercept = as_date("2018-04-01")), linetype = 2) +
  # axis and color scales
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e" ) + 
  scale_y_log10()+
  scale_color_manual(values = c("S0" = "#000000", "S1" = "#FF0000", 
                                 "S2" = "#23baaf", "S3" = "#F2AD00"),
                     breaks = c("S0", "S1", "S2", "S3")) +
  scale_shape_manual(values = 21) +
  # axis labels
  xlab(NULL) + 
  ylab(expression(NO[3]^{"-"} ~~ "(mg-N" ~~ L^{-1} * ")"))+
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "none", legend.title = element_blank())

# Temperature and discharge
b <- 
  ggplot(data = sensor_desoto, aes(x = date)) +
  # Upstream (Bowersock)
  geom_line(aes(y = WaterTemp_C), color = "black") +
  geom_line(aes(y = Discharge_m3s/2.2), color = "darkgrey") +
  #geom_point(aes(y = WaterTemp_C, color = "S0")) +
  # Vertical line at 1-Apr-18
  geom_vline(aes(xintercept = as_date("2018-04-01")), linetype = 2) +
  # axis and color scales
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e" ) + 
  scale_y_continuous(limits = c(0,50), 
                     sec.axis = sec_axis(~.*2.2, name = expression("Q ("*m^3 ~ s^{-1} *")"))) +
  #scale_y_log10()+
  #scale_color_manual(values = c("S0" = "#000000", "S1" = "#FF0000", 
   #                              "S2" = "#23baaf", "S3" = "#F2AD00"),
    #                 breaks = c("S0", "S1", "S2", "S3")) +
  scale_shape_manual(values = 21) +
  # axis labels
  xlab(NULL) + 
  ylab(expression("T ("*{degree}*C * ")"))+
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "none", legend.title = element_blank())
#ggsave("./Plots/temp.png", height = 2, width = 6, units = "in")

# Arrange plots
lay <- rbind(c(1,1,1),
             c(1,1,1),
             c(2,2,2))
gridExtra::grid.arrange(a, b, layout_matrix = lay)

# Average temperature
mean(sensor_desoto$WaterTemp_C, na.rm = TRUE)
sd(sensor_desoto$WaterTemp_C, na.rm = TRUE)
min(sensor_desoto$WaterTemp_C, na.rm = TRUE)
max(sensor_desoto$WaterTemp_C, na.rm = TRUE)
# Average discharge
mean(sensor_desoto$Discharge_m3s, na.rm = TRUE)
sd(sensor_desoto$Discharge_m3s, na.rm = TRUE)
# Average nitrate
mean(massbal$Nitrate.eric_mgNL[massbal$date < ymd("2018-04-01")], na.rm = TRUE) # during
mean(massbal$Nitrate.eric_mgNL[massbal$date >= ymd("2018-04-01")], na.rm = TRUE) # post
mean(massbal$Nitrate.steve_mgNL[massbal$date < ymd("2018-04-01")], na.rm = TRUE) # during
mean(massbal$Nitrate.steve_mgNL[massbal$date >= ymd("2018-04-01")], na.rm = TRUE) # post
mean(massbal$Nitrate.desoto_mgNL[massbal$date < ymd("2018-04-01")], na.rm = TRUE) # during
mean(massbal$Nitrate.desoto_mgNL[massbal$date >= ymd("2018-04-01")], na.rm = TRUE) # post

# N supply plot
ggplot(data = massbal, aes(x = date)) +
  # Upstream (Bowersock)
  #geom_line(aes(y = NitrateLoad.bowersock_gNday/1000, color = "S0")) +
  #geom_point(aes(y = NitrateLoad.bowersock_gNday/1000, color = "S0")) +
  # Bowersock: BDL designation
  #geom_point(data = massbal[massbal$Nitrate.bowersock_mgNL <= 0.1,],
   #          aes(y = NitrateLoad.bowersock_gNday/1000), shape = 21, fill = "white") +
  # Discharge (Eric)
  geom_line(aes(y = NitrateSupply.eric_gNm2day, color = "S1")) +
  geom_point(aes(y = NitrateSupply.eric_gNm2day, color = "S1")) +
  # Downstream (Steve)
  geom_line(aes(y = NitrateSupply.steve_gNm2day, color = "S2")) +
  geom_point(aes(y = NitrateSupply.steve_gNm2day, color = "S2")) +
  # Desoto
  geom_line(aes(y = NitrateSupply.desoto_gNm2day, color = "S3")) +
  geom_point(aes(y = NitrateSupply.desoto_gNm2day, color = "S3")) +
  # Vertical line at 1-Apr-18
  geom_vline(aes(xintercept = as_date("2018-04-01")), linetype = 2) +
  # axis and color scales
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e" ) + 
  scale_y_log10()+
  scale_color_manual(values = c("S0" = "#000000", "S1" = "#FF0000", 
                                 "S2" = "#23baaf", "S3" = "#F2AD00"),
                     breaks = c("S0", "S1", "S2", "S3")) +
  scale_shape_manual(values = 21) +
  # axis labels
  xlab(NULL) + 
  ylab(expression(NO[3]^{"-"}-N ~~ "Supply  (g" ~~ m^{-2} ~ day^{-1} * ")"))+
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "bottom", legend.title = element_blank())
```

```{r Fig 3: Metabolism vs ReleaseStatus}
### Assemble data into a boxplot ###############################################
metab.long <- 
  metab.long %>%
  mutate(value = ifelse(model == "ER", -value, value))
metab.long <- 
  metab.long %>%
  mutate(Month = factor(month(Date, label = TRUE, abbr = TRUE)),
         WeekGroup = factor(round_date(Date, period(week = 2))))

# Metbolism plot
ggplot(data = subset(metab.long, Date >= "2018-02-01" & Date < "2018-05-01"), 
       aes(x = Month, y = value, color = site)) +
  facet_grid(model~site, scales = "free", switch = "y") +
  # Error bars
  stat_boxplot(geom = "errorbar", width = 0.5, 
               position = position_dodge(width = 0.75)) +
  # Boxplot
  geom_boxplot(outlier.shape = NA) +
  #geom_point() +
  #geom_line() +
  # Jitter points
  geom_point(position = position_jitterdodge(dodge.width = 0.75, 
                                             jitter.width = 0.7), 
             alpha = 0.4, shape = 16) +
  # Add text for significance
  ggpubr::stat_compare_means(aes(group = Month), #label = "p.signif", 
                             hide.ns = FALSE) +
  # Axis labels
  labs(x = NULL, 
       y = bquote("(g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) +
  # Theme adjustments
  theme_classic() +
  scale_color_manual(values = c("S1" = "#FF0000", 
                                "S2" = "#23baaf", "S3" = "#F2AD00"),
                     breaks = c("S1", "S2", "S3")) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "none")
ggsave("./Plots/MetabPlot2.png", height = 4.5, width = 5.5, units = "in")

ggpubr::compare_means(data = metab.long, value~site, 
                      group.by = c("model", "Month"))
# Average stats
mean(subset(metab_eric, date >= "2018-02-01" & date < "2018-05-01")$GPP, 
            na.rm = TRUE)
mean(subset(metab_steve, date >= "2018-02-01" & date < "2018-05-01")$GPP, 
            na.rm = TRUE)
mean(subset(metab_desoto, date >= "2018-02-01" & date < "2018-05-01")$GPP.desoto, 
            na.rm = TRUE)
mean(subset(metab_eric, date >= "2018-02-01" & date < "2018-05-01")$ER, 
            na.rm = TRUE)
mean(subset(metab_steve, date >= "2018-02-01" & date < "2018-05-01")$ER, 
            na.rm = TRUE)
mean(subset(metab_desoto, date >= "2018-02-01" & date < "2018-05-01")$ER.desoto, 
            na.rm = TRUE)
```

```{r Fig 3: Uptake vs time significance testing}
## Significance testing ########################################################
# Get summary statistics for each group
uptake.long %>%
  subset(Date < "2018-05-01") %>%
  group_by(site, ReleaseStatus) %>%
  filter(!is.na(UaNO3_gNm2day)) %>%
  summarise(n = n(),
            mean = mean(UaNO3_gNm2day, na.rm = TRUE),
            sd = sd(UaNO3_gNm2day, na.rm = TRUE))
# Perform two-way anova to assess the affect of two grouping variables 
# (site & release status) on response (uptake)
anova.uptake <- aov(UaNO3_gNm2day ~ ReleaseStatus * site, data = subset(uptake.long, Date<"2018-05-01"))
summary(anova.uptake) 
# Get multiple pairwise comparisons between the means of groups (to see specifically which groups differ) using Tukey honest significant differences 
TukeyHSD(anova.uptake) # differences between sites 

# Set up positions for significance letters
positions <- data.frame(site = c("S1", "S1", "S2", "S2", "S3", "S3"),
                              UaNO3_gNm2day = c(1E7,2E6,9E5,1E5,9E5,3E5),
                              ReleaseStatus = factor(c("During", "After",
                                                       "During", 
                                                       "After", "During",  
                                                       "After"), 
                                                     levels = c("During", 
                                                                "After")))
```

```{r Fig 4: Uptake vs time plotting}
### Assemble data into a boxplot ##############################################
ggpubr::compare_means(data = uptake.metab.mass.long, UaNO3_gNm2day~ReleaseStatus, 
                      group.by = c("site"))
uptake.metab.mass.long <- 
  uptake.metab.mass.long %>% 
  mutate(Month = factor(month(Date, label = TRUE, abbr = TRUE)),
         WeekGroup = factor(round_date(Date, period(week = 3))))
str(uptake.metab.mass.long)

# Boxplot
# Broken up by ReleaseStatus
ggplot(data = subset(uptake.metab.mass.long, model == "GPP"), aes(x = Month, 
                                          y = UaNO3_gNm2day, color = site)) +
  facet_wrap(~site) +
  # Error bars
  stat_boxplot(geom = "errorbar", width = 0.5, 
               position = position_dodge(width = 0.75)) +
  # Add text for significance
  ggpubr::stat_compare_means(aes(group = Month), label = "p.signif", 
                             label.x = 1.4, hide.ns = F) +
  # Boxplots
  geom_boxplot(outlier.shape = NA) +
  # Jitter points
  geom_point(position = position_jitterdodge(dodge.width = 0.75, 
                                             jitter.width = 0.7), 
             alpha = 0.4, shape = 16) +
  scale_y_log10(breaks = c(1,10,100,1E3,1E4)) +
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                              "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # axis labels
  xlab(NULL) + 
  ylab(expression("Uptake (g-N" ~~ m^{-2} ~ day^{-1} * ")")) +
  # plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
ggsave("./Plots/Uptake_boxplot.png", height = 4.5, width = 5.5, units = "in")

# Broken up monthly
ggplot(data = uptake.metab.mass.long, aes(x = factor(month(Date, label = TRUE, 
                                                           abbr = TRUE)), 
                                          y = UaNO3_gNm2day, color = site)) +
  facet_wrap(~site) +
  # Error bars
  stat_boxplot(geom = "errorbar", width = 0.5, 
               position = position_dodge(width = 0.75)) +
  # Add text for significance
  ggpubr::stat_compare_means(aes(group = factor(month(Date, label = TRUE, 
                                                      abbr = TRUE))),
                             label = "p.signif", 
                             label.x = 1.4, hide.ns = F) +
  # Boxplots
  geom_boxplot(outlier.shape = NA) +
  # Jitter points
  geom_point(position = position_jitterdodge(dodge.width = 0.75, 
                                             jitter.width = 0.7), 
             alpha = 0.4, shape = 16) +
  scale_y_log10(breaks = c(1,10,100,1E3,1E4)) +
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                                "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # axis labels
  xlab("date") + 
  ylab(expression(Ua-NO[3]^{"-"} ~~ "(g-N" ~~ m^{-2} ~ day^{-1} * ")")) +
  # plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
# Save
ggsave("./Plots/Uptake_boxplot.png", height = 3.5, width = 5.5, units = "in")

### x axis as time ###
ggplot(data = uptake, aes(x = Date)) +
  # Discharge (Eric)
  geom_smooth(data = subset(uptake, ReleaseStatus == "During"), 
              aes(y = UaNO3_gNm2day.eric, color = "S1"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_smooth(data = subset(uptake, ReleaseStatus == "After"), 
              aes(y = UaNO3_gNm2day.eric, color = "S1"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_point(aes(y = UaNO3_gNm2day.eric, color = "S1")) +
  # Steve
  geom_smooth(data = subset(uptake, ReleaseStatus == "During"), 
              aes(y = UaNO3_gNm2day.steve, color = "S2"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_smooth(data = subset(uptake, ReleaseStatus == "After"), 
              aes(y = UaNO3_gNm2day.steve, color = "S2"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_point(aes(y = UaNO3_gNm2day.steve, color = "S2")) +
  # Desoto
  geom_smooth(data = subset(uptake, ReleaseStatus == "During"), 
              aes(y = UaNO3_gNm2day.desoto, color = "S3"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_smooth(data = subset(uptake, ReleaseStatus == "After"), 
              aes(y = UaNO3_gNm2day.desoto, color = "S3"), 
              formula = y~x, method = "lm", se = FALSE) +
  geom_point(aes(y = UaNO3_gNm2day.desoto, color = "S3")) +
  # Horizontal line at 1 April, pump shutoff date
  geom_vline(aes(xintercept = as_date("2018-04-01")), linetype = 2) +
  # Axis scales
  scale_y_log10() +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e") + 
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                                "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # axis labels
  xlab(NULL) + 
  ylab(expression(Ua-NO[3]^{"-"} ~~ "(g-N" ~~ m^{-2} ~ day^{-1} * ")")) +
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = "bottom", legend.title = element_blank())
# Save plot
ggsave("./Plots/Uptake_time.png", height = 3, width = 6, units = "in")

##### Calculate uptake velocity

# vf = U [g-N / m2 day] / NO3 [mg-N / L] * 1000 [mg-N / g-N] / 1000 [m3 / L] 
#    = vf [m / day] / 1440 [day / min] * 1000 [mm/m] = vf [mm/min]
uptake$vf_mmmin.eric <- 
  uptake$UaNO3_gNm2day.eric / uptake$Mean.Nitrate_mgL.eric / 1440 * 1000
uptake$vf_mmmin.steve <- 
  uptake$UaNO3_gNm2day.steve / uptake$Mean.Nitrate_mgL.steve / 1440 * 1000
uptake$vf_mmmin.desoto <- 
  uptake$UaNO3_gNm2day.desoto / uptake$Mean.Nitrate_mgL.desoto / 1440 * 1000
# Adjust data frame structure
vf <- tidyr::gather(uptake, key = site, value = vf_mmmin, 
                    vf_mmmin.eric:vf_mmmin.desoto)
vf$site <- factor(vf$site, levels = c("vf_mmmin.eric", "vf_mmmin.steve", 
                                      "vf_mmmin.desoto"))
levels(vf$site)[levels(vf$site)=="vf_mmmin.eric"] <- "S1"
levels(vf$site)[levels(vf$site)=="vf_mmmin.steve"] <- "S2"
levels(vf$site)[levels(vf$site)=="vf_mmmin.desoto"] <- "S3"
vf <- vf[-c(2:16)]
vf <- subset(vf, Date < "2018-05-01")
vf$Month <- lubridate::month(vf$Date, label = TRUE, abbr = TRUE)

# Boxplot
ggplot(data = vf, aes(x = Month, y = vf_mmmin, color = site)) +
  facet_grid(~site) +
  # Error bars
  stat_boxplot(geom = "errorbar", width = 0.5, 
               position = position_dodge(width = 0.75)) +
  # Box plots
  geom_boxplot(outlier.shape = NA) +
  # Jitter points
  geom_point(position = position_jitterdodge(dodge.width = 0.75, 
                                             jitter.width = 0.9), 
             alpha = 0.4, shape = 16) +
  # Add text for significance
  ggpubr::stat_compare_means(aes(group = Month),
                             label.x = 1.4, hide.ns = F) +
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                                "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))

# Time plot
ggplot(data = vf, aes(x = Date, y = vf_mmmin, color = site)) +
  facet_grid(~site) +
  #geom_smooth(data = subset(vf, ReleaseStatus == "During"), method = "lm") +
  #geom_smooth(data = subset(vf, ReleaseStatus == "After"), method = "lm") +
  geom_point() +
  geom_line()+
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                                "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))

vf.metab <- dplyr::full_join(metab.long, vf, by = c("Date", "site", "ReleaseStatus"))
vf.metab$date <- NULL
ggplot(vf.metab, aes(x = value, y = vf_mmmin, color = site)) +
  facet_grid(site~model, switch = "y") +
  geom_point() +
  geom_smooth(method = "lm") +
  ggpubr::stat_cor(color = "black") 
```

```{r Fig 5: Uptake vs metabolism.... think about a diff fig}
# Scatterplot GPP vs Ua
ggplot(subset(uptake.metab.mass.long, model == "GPP"), aes(x = value, 
                                                      y = UaNO3_gNm2day, 
                                                      color = site)) +
  facet_grid(site~ReleaseStatus, scales = "free", switch = "y") +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  # Add correlation coeff
  ggpubr::stat_cor(method = "spearman", color = "black") +
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                                "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # Axis labels
  xlab(bquote("GPP (g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab(expression(Ua-NO[3]^{"-"} ~~ "(g-N" ~~ m^{-2} ~ day^{-1} * ")")) +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))

# Scatterplot ER vs Ua
ggplot(subset(uptake.metab.mass.long, model == "ER"), aes(x = value, 
                                                     y = UaNO3_gNm2day, 
                                                     color = site)) +
  facet_grid(site~ReleaseStatus, scales = "free", switch = "y") +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  # Add correlation coeff
  ggpubr::stat_cor(method = "spearman", color = "black") +
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                                "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # Axis labels
  xlab(bquote("ER (g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab(expression(Ua-NO[3]^{"-"} ~~ "(g-N" ~~ m^{-2} ~ day^{-1} * ")")) +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))

# All together graph
ggplot(uptake.metab.mass.long, aes(x = value, y = UaNO3_gNm2day, 
                              color = ReleaseStatus)) +
  facet_grid(site ~ model, scales = "free", switch = "y") +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE) +
  # Add correlation coeff
  #ggpubr::stat_cor(color = "black") +
  # Color scales
  #scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
   #                             "S3" = "#F2AD00"),
    #                 limits = c("S1", "S2", "S3")) +
  # Axis labels
  xlab(bquote("GPP or ER (g-" *O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab(expression(Ua-NO[3]^{"-"} ~~ "(g-N" ~~ m^{-2} ~ d^{-1} * ")")) +
  # Plot theme
  theme_classic() +
  theme(#legend.position = "none", 
        legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
```

```{r Fig 6: Nitrate load vs uptake}
# Fig 5 nitrate load vs nitrate uptake scatterplot
ggplot(subset(uptake.metab.mass.long, site == "S2" | site ==  "S3"), 
       aes(x = NitrateSupply_gNm2day, y = UaNO3_gNm2day)) +
  facet_grid(site~., scales = "free", switch = "y") +
  geom_point(alpha = 0.4, shape = 16) +
  #scale_x_log10() +
  #scale_y_log10() +
  geom_smooth(fullrange = FALSE) +
  # Add correlation coeff
  ggpubr::stat_cor(color = "black", method = "spearman") +
  # Color scales
  #scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
   #                             "S3" = "#F2AD00"),
    #                 limits = c("S1", "S2", "S3")) +
  # Axis labels
  xlab(expression(NO[3]^{"-"} ~~ "Supply  (g-N" ~~ m^{-2} ~ day^{-1} * ")")) + 
  ylab(expression(Ua-NO[3]^{"-"} ~~ "(g-N" ~~ m^{-2} ~ day^{-1} * ")")) +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))


ggplot(uptake.metab.mass.long, aes(x = factor(month(Date, label = TRUE, abbr = TRUE)), 
                                   y = NitrateSupply_gNm2day/UaNO3_gNm2day,
                                   color = site)) +
  facet_grid(~site) +
  # Add line at median of data
  stat_boxplot(geom = "errorbar", width = 0.5, 
               position = position_dodge(width = 0.75)) +
  # Add data points
  geom_jitter(width = 0.2, alpha = 0.4, shape = 16) +
  stat_summary(fun.y = mean, fun.ymin = mean, fun.ymax = mean, size = 1.5, 
               shape = 21, fill = "white") +
  # Add text for significance
  ggpubr::stat_compare_means(#label = "p.signif", 
                             aes(group = factor(month(Date, label = TRUE, 
                                                      abbr = TRUE)))) +
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                                "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # Axis labels
  xlab(NULL) + 
  ylab("Supply : Uptake") +
  # Plot theme
  theme_classic() +
  scale_y_log10() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
ggsave("./Plots/supplydemand.png", height = 5, width = 4.5, units = "in")

# Supply:demand
ggplot(uptake.metab.mass.long, aes(x = ReleaseStatus, 
                                   y = NitrateSupply_gNm2day/UaNO3_gNm2day,
                                   color = site)) +
  facet_grid(~site) +
  # Add line at median of data
  #stat_summary(fun.y = median, fun.ymin = median, fun.ymax = median, 
   #            geom = "crossbar", width = 0.6) +
  
  # Add data points
  #geom_jitter(width = 0.2, alpha = 0.4, shape = 16) +
  # Add text for significance
  ggpubr::stat_compare_means(aes(group = ReleaseStatus)) +
  # Color scales
  scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
                                "S3" = "#F2AD00"),
                     limits = c("S1", "S2", "S3")) +
  # Axis labels
  xlab("Release status") + 
  ylab(expression("N supply :" ~ Ua-NO[3]^{"-"})) +
  # Plot theme
  theme_classic() +
  scale_y_log10() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))

# Broken up by week
ggplot(uptake.metab.mass.long, aes(x = factor(round_date(Date, unit = period(day = 21))), 
                                   y = NitrateSupply_gNm2day/UaNO3_gNm2day,
                                   color = ReleaseStatus)) +
  facet_grid(~site) +
  # Add line at median of data
  #stat_summary(fun.y = median, fun.ymin = median, fun.ymax = median, 
   #            geom = "crossbar", width = 1) +
  
  geom_boxplot(outlier.shape = NA) +
  # Add data points
  geom_point(alpha = 0.4, shape = 16) +
  # Add text for significance
  #ggpubr::stat_compare_means(aes(group = round_date(Date, unit = "2 weeks"))) +
  # Color scales
 # scale_color_manual(values = c("S1" = "#FF0000", "S2" = "#23baaf", 
  #                              "S3" = "#F2AD00"),
   #                  limits = c("S1", "S2", "S3")) +
  scale_y_log10()

round_date(uptake.metab.mass.long$Date, unit = period(week = 2))
```

```{r Fig 7: Meta-analysis}
### Assemble means of our data
# Set up empty data frame
means <- data.frame(Site = c("S1", "S2", "S3"),
                    Nitrate_mgL.Overall = numeric(length = 3),
                    Nitrate_mgL.During = numeric(length = 3),
                    Nitrate_mgL.After = numeric(length = 3),
                    Discharge_m3s.Overall = numeric(length = 3),
                    U_gNm2day.Overall = numeric(length = 3),
                    U_gNm2day.During = numeric(length = 3),
                    U_gNm2day.After = numeric(length = 3),
                    GPP_gO2m2day.Overall = numeric(length = 3),
                    ER_gO2m2day.Overall = numeric(length = 3))
# Nitrate
means$Nitrate_mgL.Overall <- 
  c(mean(uptake$Mean.Nitrate_mgL.eric[uptake$Date >= "2018-02-01" & 
                                        uptake$Date < "2018-05-01"], na.rm = TRUE),
    mean(uptake$Mean.Nitrate_mgL.steve[uptake$Date >= "2018-02-01" & 
                                         uptake$Date < "2018-05-01"], na.rm = TRUE),
    mean(uptake$Mean.Nitrate_mgL.desoto[uptake$Date >= "2018-02-01" & 
                                          uptake$Date < "2018-05-01"], na.rm = TRUE))
means$Nitrate_mgL.During <- 
  c(mean(uptake$Mean.Nitrate_mgL.eric[uptake$Date >= "2018-02-01" & 
                                        uptake$Date < "2018-04-01"], na.rm = TRUE),
    mean(uptake$Mean.Nitrate_mgL.steve[uptake$Date >= "2018-02-01" & 
                                         uptake$Date < "2018-04-01"], na.rm = TRUE),
    mean(uptake$Mean.Nitrate_mgL.desoto[uptake$Date >= "2018-02-01" & 
                                          uptake$Date < "2018-04-01"], na.rm = TRUE))
means$Nitrate_mgL.After <- 
  c(mean(uptake$Mean.Nitrate_mgL.eric[uptake$Date >= "2018-04-01" & 
                                        uptake$Date < "2018-05-01"], na.rm = TRUE),
    mean(uptake$Mean.Nitrate_mgL.steve[uptake$Date >= "2018-04-01" & 
                                         uptake$Date < "2018-05-01"], na.rm = TRUE),
    mean(uptake$Mean.Nitrate_mgL.desoto[uptake$Date >= "2018-04-01" & 
                                          uptake$Date < "2018-05-01"], na.rm = TRUE))
# Discharge
means$Discharge_m3s.Overall <- 
  c(mean(uptake$Mean.Discharge_m3s.eric[uptake$Date >= "2018-02-01" & 
                                        uptake$Date < "2018-05-01"], na.rm = TRUE),
    mean(uptake$Mean.Discharge_m3s.steve[uptake$Date >= "2018-02-01" & 
                                         uptake$Date < "2018-05-01"], na.rm = TRUE),
    mean(uptake$Mean.Discharge_m3s.desoto[uptake$Date >= "2018-02-01" & 
                                          uptake$Date < "2018-05-01"], na.rm = TRUE))
# Uptake
means$U_gNm2day.Overall <- 
  c(mean(uptake$Mean.Discharge_m3s.eric[uptake$Date >= "2018-02-01" & 
                                        uptake$Date < "2018-05-01"], na.rm = TRUE),
    mean(uptake$Mean.Discharge_m3s.steve[uptake$Date >= "2018-02-01" & 
                                         uptake$Date < "2018-05-01"], na.rm = TRUE),
    mean(uptake$Mean.Discharge_m3s.desoto[uptake$Date >= "2018-02-01" & 
                                          uptake$Date < "2018-05-01"], na.rm = TRUE))
means$U_gNm2day.During <- 
means$U_gNm2day.After <- 


# discharge vs uptake velocity dotplot
ggplot(data = tank, aes(x = Discharge_Ls, y = NO3_Vf_mmmin)) +
  geom_point(shape = 21) +
  geom_smooth(method = "lm") +
  # Add correlation coeff
  ggpubr::stat_cor(color = "black", method = "spearman") +
  # Axis scales
  scale_x_log10() +
  scale_y_log10() +
  # Axis labels
  xlab(expression("discharge L/s")) + 
  ylab(expression(Vf-NO[3]^{"-"} ~~ "(mm" ~ min^{-1} * ")")) +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))



# Overall means
desoto_uptakemeans$Nitrate_mgL.Overall <- 
  mean(uptake$Mean.Nitrate_mgL.desoto[uptake$Date < "2018-05-01"], 
       na.rm = TRUE)
desoto_uptakemeans$Discharge_m3s.Overall <- 
  mean(uptake$Mean.Discharge_m3s.desoto[uptake$Date < "2018-05-01"], 
       na.rm = TRUE)

desoto_uptakemeans$UaNO3_gNm2day.Overall <- 
  mean(uptake$UaNO3_gNm2day.desoto[uptake$Date < "2018-05-01"], 
       na.rm = TRUE)
# During pumping
desoto_uptakemeans$Nitrate_mgL.During <- 
  mean(uptake$Mean.Nitrate_mgL.desoto[uptake$Date > "2018-02-01" & 
                                        uptake$Date < "2018-04-01"], 
       na.rm = TRUE)
desoto_uptakemeans$Discharge_m3s.During <- 
  mean(uptake$Mean.Discharge_m3s.desoto[uptake$Date > "2018-02-01" & 
                                        uptake$Date < "2018-04-01"], 
       na.rm = TRUE)
desoto_uptakemeans$UaNO3_gNm2day.During <- 
  mean(uptake$UaNO3_gNm2day.desoto[uptake$Date > "2018-02-01" & 
                                        uptake$Date < "2018-04-01"], 
       na.rm = TRUE)
# After
desoto_uptakemeans$Nitrate_mgL.After <- 
  mean(uptake$Mean.Nitrate_mgL.desoto[uptake$Date > "2018-04-01" & 
                                      uptake$Date < "2018-05-01"], 
       na.rm = TRUE)
desoto_uptakemeans$Discharge_m3s.After <- 
  mean(uptake$Mean.Discharge_m3s.desoto[uptake$Date > "2018-04-01" & 
                                        uptake$Date < "2018-05-01"], 
       na.rm = TRUE)
desoto_uptakemeans$UaNO3_gNm2day.After <- 
  mean(uptake$UaNO3_gNm2day.desoto[uptake$Date > "2018-04-01" & 
                                        uptake$Date < "2018-05-01"], 
       na.rm = TRUE)
desoto_uptakemeans <- as.data.frame(desoto_uptakemeans)
# Average stats
mean(subset(metab_eric, date >= "2018-02-01" & date < "2018-05-01")$GPP, 
            na.rm = TRUE)
mean(subset(metab_steve, date >= "2018-02-01" & date < "2018-05-01")$GPP, 
            na.rm = TRUE)
mean(subset(metab_desoto, date >= "2018-02-01" & date < "2018-05-01")$GPP.desoto, 
            na.rm = TRUE)
mean(subset(metab_eric, date >= "2018-02-01" & date < "2018-05-01")$ER, 
            na.rm = TRUE)
mean(subset(metab_steve, date >= "2018-02-01" & date < "2018-05-01")$ER, 
            na.rm = TRUE)
mean(subset(metab_desoto, date >= "2018-02-01" & date < "2018-05-01")$ER.desoto, 
            na.rm = TRUE)

# vf mm/min * NO3 mg/L *[1000L/m3] *[1m/1000mm] *[1g/1000mg] * [1440 min/d] = gN/day*m2
# I don't think the snake r is included in this dataset
# discharge vs uptake velocity dotplot
ggplot() +
  # Data from tank metanalysis
  geom_point(data = tank, aes(x = Discharge_Ls, y = NO3_Vf_mmmin*NO3_Cb_mgNL*1000/1000/1000*1440), 
             shape = 21) +
  #geom_point(data=desoto_uptakemeans, aes(x = Discharge_m3s.Overall*1000, y = UaNO3_gNm2day.Overall), 
  #           color = "blue") +
  geom_point(data=desoto_uptakemeans, aes(x = Discharge_m3s.During*1000, y = UaNO3_gNm2day.During), 
             color = "red") +
  geom_point(data=desoto_uptakemeans, aes(x = Discharge_m3s.After*1000, y = UaNO3_gNm2day.After), 
             color = "green") +
  geom_smooth(data = tank, aes(x = Discharge_Ls, y = NO3_Vf_mmmin*NO3_Cb_mgNL*1000/1000/1000*1440), method = "lm") +
  #geom_point(data = desoto_uptakemeans, aes(x = Discharge_m3s.Overall, y = )
  # Add correlation coeff
  ggpubr::stat_cor(data = tank, aes(x = Discharge_Ls, y = NO3_Vf_mmmin*NO3_Cb_mgNL*1000/1000/1000*1440),
                   color = "black", method = "spearman") +
  # Axis scales
  scale_x_log10(limits = c(0.1, 100000)) +
  scale_y_log10(limits = c(0.0001, 10000)) +
  # Axis labels
  xlab(expression("Q ( L" ~ sec^{-1} * ")")) + 
  ylab(expression(U-NO[3]^{"-"} ~~ "(gN m2 day)")) +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))


# Discharge vs metabolism dotplot
# Extract mean GPP
metab.long %>%
  subset(site == "S1" & Date < "2018-05-01" & model = "GPP") %>%
  summarise(mean(na.rm = TRUE))

ggplot(data = hall, aes(x = q_m3s, y = gpp_gm2d)) +
  geom_point(color = "darkgrey") +
  #geom_smooth(method = "lm") +
  # Add correlation coeff
  #ggpubr::stat_cor(color = "black", method = "spearman") +
  # Axis scales
  scale_x_log10() +
  scale_y_log10() +
  # Axis labels
  xlab(expression("Discharge ("*m^{3} ~ s^{-1}*")")) + 
  ylab(expression("GPP (g" ~ O[2] ~ m^{-2} ~ d^{-1}*")")) +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))

```

```{r supplemental}
# Plotting gpp vs water temp to see if gpp vs ua relationships are temp dependent
# eric
ggplot(data = sensor_eric, aes(x = GPP, y = WaterTemp_C)) +
  facet_grid(~ReleaseStatus) +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  # Add correlation coeff
  ggpubr::stat_cor(method = "spearman", color = "black") +
  # Axis labels
  xlab(bquote("GPP (g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab("Daily average water temp (deg C)") +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
# steve
ggplot(data = sensor_steve, aes(x = GPP, y = WaterTemp_C)) +
  facet_grid(~ReleaseStatus) +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  # Add correlation coeff
  ggpubr::stat_cor(method = "spearman", color = "black") +
  # Axis labels
  xlab(bquote("GPP (g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab("Daily average water temp (deg C)") +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
# desoto
ggplot(data = sensor_desoto, aes(x = GPP.desoto, y = WaterTemp_C)) +
  facet_grid(~ReleaseStatus) +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  # Add correlation coeff
  ggpubr::stat_cor(method = "spearman", color = "black") +
  # Axis labels
  xlab(bquote("GPP (g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab("Daily average water temp (deg C)") +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
# ER
# eric
ggplot(data = sensor_eric, aes(x = ER, y = WaterTemp_C)) +
  facet_grid(~ReleaseStatus) +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  # Add correlation coeff
  ggpubr::stat_cor(method = "spearman", color = "black") +
  # Axis labels
  xlab(bquote("ER (g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab("Daily average water temp (deg C)") +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
# steve
ggplot(data = sensor_steve, aes(x = ER, y = WaterTemp_C)) +
  facet_grid(~ReleaseStatus) +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  # Add correlation coeff
  ggpubr::stat_cor(method = "spearman", color = "black") +
  # Axis labels
  xlab(bquote("ER (g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab("Daily average water temp (deg C)") +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))
# desoto
ggplot(data = sensor_desoto, aes(x = ER.desoto, y = WaterTemp_C)) +
  facet_grid(~ReleaseStatus) +
  geom_point(alpha = 0.4, shape = 16) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  # Add correlation coeff
  ggpubr::stat_cor(method = "spearman", color = "black") +
  # Axis labels
  xlab(bquote("ER (g" ~~ O[2] ~ m^-2 ~ d^-1 ~ ")")) + 
  ylab("Daily average water temp (deg C)") +
  # Plot theme
  theme_classic() +
  theme(legend.position = "none", legend.title = element_blank(),
        panel.border = element_rect(fill = NA), 
        axis.text = element_text(color = "black"))

```