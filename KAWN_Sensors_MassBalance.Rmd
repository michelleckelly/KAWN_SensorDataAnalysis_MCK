---
title: "KAWN_Sensors_MassBalance"
author: "Michelle Kelly"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup}
library(lubridate)
library(magrittr)
library(dplyr)
library(imputeTS)
library(ggplot2)
```

```{r load}
# load from file
loadfromfile <- TRUE

if(loadfromfile == TRUE){
  massBal <- read.csv(file = "./Outputs/NMassBalance.csv")
  massBal$date <- lubridate::ymd(massBal$date)
}

if(loadfromfile == FALSE){
  source("KAWN_Compiler_MassBalanceCSV.R")
  massBal <- read.csv(file = "./Outputs/NMassBalance.csv")
  massBal$date <- lubridate::ymd(massBal$date)
}
```

```{r reshape}
# select only loading data and
# gather from wide format to long format
Nload <- 
  massBal %>%
  select(date, NitrateLoad.farmland_kgNday:AmmoniaLoad.farmland_kgNday) %>%
  gather(species, load_kgNday, NitrateLoad.farmland_kgNday:AmmoniaLoad.farmland_kgNday)

# add a column for site ID
Nload$site[grepl("bowersock", Nload$species)] <- "Bowersock"
Nload$site[grepl("desoto", Nload$species)] <- "Desoto"
Nload$site[grepl("eric", Nload$species)] <- "Eric"
Nload$site[grepl("steve", Nload$species)] <- "Steve"
Nload$site[grepl("farmland", Nload$species)] <- "Farmland"

# change species column to just species name,
# no other info
Nload$species[grepl("Nitrate", Nload$species)] <- "NO3+NO2"
Nload$species[grepl("Ammonium", Nload$species)] <- "NH4"
Nload$species[grepl("Ammonia", Nload$species)] <- "NH3"
Nload$species[grepl("DIN", Nload$species)] <- "DIN"
```

```{r plot}
theme_set(theme_classic())

Nload[Nload$site %in% c("Eric", "Steve", "Desoto"),]

# upstream
ggplot(data = na.omit(Nload[Nload$site %in% c("Bowersock", "Farmland"),]), 
       aes(x = date)) +
  geom_point(aes(y = load_kgNday, color = species), size = 2) +
  geom_line(aes(y = load_kgNday, color = species)) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  #scale_y_continuous(limits = c(-1000, 4000), labels = scales::scientific) +
  theme(panel.border = element_rect(color = "black", fill = NA)) +
  scale_color_manual(values = c("black", "red", "blue", "green"), 
                     limits = c("NO3+NO2", "NH4", "NH3", "DIN")) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) +
  facet_grid(site ~ .)

ggplot(data = Nload[Nload$site %in% c("Bowersock", "Farmland"),], 
       aes(x = date)) +
  geom_point(aes(y = load_kgNday, color = species), size = 2) +
  geom_line(aes(y = load_kgNday, color = species)) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  #scale_y_continuous(limits = c(-1000, 4000), labels = scales::scientific) +
  theme(panel.border = element_rect(color = "black", fill = NA)) +
  scale_color_manual(values = c("black", "red", "blue", "green"), 
                     limits = c("NO3+NO2", "NH4", "NH3", "DIN")) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) +
  facet_grid(site ~ .)

# downstream
ggplot(data = Nload[Nload$site %in% c("Eric", "Steve", "Desoto"),], 
       aes(x = date)) +
  geom_point(aes(y = load_kgNday, color = species), fill = "white", size = 2, shape = 21) +
  geom_line(aes(y = load_kgNday, color = species), size = 1) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = c(0.85, 0.7), legend.background = element_rect(color = "black"),
        legend.title = element_blank()) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 45000), labels = scales::scientific) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) +
  facet_grid(. ~ factor(site, levels = c("Eric", "Steve", "Desoto")))
ggsave("./Plots/Nbal_downstreamfacet.png", width = 6, height = 3, units = "in")
```


```{r plot}
theme_set(theme_classic())

# tiny plots
# bowersock
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.bowersock_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.bowersock_kgNday, col = "NO3 + NO2"), 
             shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniumLoad.bowersock_kgNday),],
            aes(y = AmmoniumLoad.bowersock_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniumLoad.bowersock_kgNday, col = "NH4"), 
             fill = "white", shape = 24, size = 2.5) +
  geom_line(data = massBal[!is.na(massBal$DINLoad.bowersock_kgNday),],
            aes(y = DINLoad.bowersock_kgNday, col = "DIN"), size = 1) +
  geom_point(aes(y = DINLoad.bowersock_kgNday, col = "DIN"), 
             size = 2.5, shape = 23, fill = "white") +
  scale_y_continuous(limits = c(0, 4000), labels = scales::scientific) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_color_manual(values = c("black", "red", "blue", "green"), 
                     limits = c("NO3 + NO2", "NH4", "NH3", "DIN")) +
  theme(legend.position = c(0.65,0.65), legend.title = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        legend.background = element_rect(color = "black")) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) + labs(tag = "(a)")
ggsave("./Plots/NBal_bowersock.png", width = 3, height = 2.5, units = "in")
# farmland
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.farmland_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.farmland_kgNday, col = "NO3 + NO2"), shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniaLoad.farmland_kgNday),],
            aes(y = AmmoniaLoad.farmland_kgNday, col = "NH3"), size = 1) +
  geom_point(aes(y = AmmoniaLoad.farmland_kgNday, col = "NH3"), shape = 22, size = 2.5, fill = "white") +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 4000), labels = scales::scientific) +
  scale_color_manual(values = c("black", "blue"), limits = c("NO3 + NO2", "NH3")) +
  theme(legend.position = "none", panel.border = element_rect(color = "black", fill = NA)) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) + labs(tag = "(b)")
ggsave("./Plots/NBal_farmland.png", width = 3, height = 2.5, units = "in")

# eric
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.eric_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.eric_kgNday, col = "NO3 + NO2"), shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniumLoad.eric_kgNday),],
            aes(y = AmmoniumLoad.eric_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniumLoad.eric_kgNday, col = "NH4"), shape = 24, size = 2.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$DINLoad.eric_kgNday),],
            aes(y = DINLoad.eric_kgNday, col = "DIN"), size = 1) +
  geom_point(aes(y = DINLoad.eric_kgNday, col = "DIN"), shape = 23, size = 2.5, fill = "white") +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 45000), labels = scales::scientific) +
  scale_color_manual(values = c("black", "red", "green"), limits = c("NO3 + NO2", "NH4", "DIN")) +
  theme(legend.position = "none", panel.border = element_rect(color = "black", fill = NA)) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")")))
ggsave("./Plots/NBal_eric.png", width = 2.5, height = 3, units = "in")
# steve
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.steve_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.steve_kgNday, col = "NO3 + NO2"), 
             shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniumLoad.steve_kgNday),],
            aes(y = AmmoniumLoad.steve_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniumLoad.steve_kgNday, col = "NH4"), 
             shape = 24, size = 2.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$DINLoad.steve_kgNday),],
            aes(y = DINLoad.steve_kgNday, col = "DIN"), size = 1) +
  geom_point(aes(y = DINLoad.steve_kgNday, col = "DIN"), 
             shape = 23, size = 2.5, fill = "white") +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 45000), labels = NULL) +
  scale_color_manual(values = c("black", "red", "green"), limits = c("NO3 + NO2", "NH4", "DIN")) +
  theme(legend.position = "none", panel.border = element_rect(color = "black", fill = NA)) +
  xlab(NULL) + ylab(NULL)
ggsave("./Plots/NBal_steve.png", width = 1.75, height = 3, units = "in")
# desoto
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.desoto_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.desoto_kgNday, col = "NO3 + NO2"), 
             shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniumLoad.desoto_kgNday),],
            aes(y = AmmoniumLoad.desoto_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniumLoad.desoto_kgNday, col = "NH4"), 
             shape = 24, size = 2.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$DINLoad.desoto_kgNday),],
            aes(y = DINLoad.desoto_kgNday, col = "DIN"), size = 1) +
  geom_point(aes(y = DINLoad.desoto_kgNday, col = "DIN"), shape = 23, size = 2.5, fill = "white") +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 25000), labels = NULL) +
  scale_color_manual(values = c("black", "red", "blue", "green"), 
                     limits = c("NO3 + NO2", "NH4", "NH3", "DIN")) +
  theme(legend.position = c(0.6,0.75), legend.title = element_blank(), 
        legend.background = element_rect(color = "black"),
        panel.border = element_rect(color = "black", fill = NA)) +
  xlab(NULL) + ylab(NULL)
ggsave("./Plots/NBal_desoto.png", width = 1.75, height = 3, units = "in")


#####################
ggplot(data = massCalcs, aes(x = date, y = farmland_kgNday)) +
  geom_line() +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-30"))) +
  xlab(NULL) + ylab(expression(paste("Nitrate load (kg-N ", day^-1, ")")))
ggplot(data = massCalcs, aes(x = date, y = eric_kgNday)) +
  geom_line() +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-30"))) +
  xlab(NULL) + ylab(expression(paste("Nitrate load (kg-N ", day^-1, ")")))
ggplot(data = massCalcs, aes(x = date, y = steve_kgNday)) +
  geom_line() +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-30"))) +
  xlab(NULL) + ylab(expression(paste("Nitrate load (kg-N ", day^-1, ")")))
ggplot(data = massCalcs, aes(x = date, y = desoto_kgNday)) +
  geom_line() +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-30"))) +
  xlab(NULL) + ylab(expression(paste("Nitrate load (kg-N ", day^-1, ")")))





# subset just the calculated mass loads
massCalcs <- data.frame(date = massBal$date,
                        bowersock_kgNday = massBal$NitrateLoad.bowersock_kgNday,
                        farmland_kgNday = massBal$NitrateLoad.farmland_kgNday,
                        eric_kgNday = massBal$NitrateLoad.eric_kgNday,
                        steve_kgNday = massBal$NitrateLoad.steve_kgNday,
                        desoto_kgNday = massBal$NitrateLoad.desoto_kgNday)

# make a "calculated load" for erics
massCalcs$bowersock.add.farmland <- massCalcs$bowersock_kgNday + massCalcs$farmland_kgNday

# plotting measured load at desoto, measured load at steve, 
# and calculated load at eric's (bowersock load + farmland load)
ggplot(data = massCalcs, aes(x = date)) +
  geom_area(aes(y = desoto_kgNday, fill = "desoto measured"), col = "black") +
  geom_area(aes(y = steve_kgNday, fill = "steve measured"), col = "blue") +
  geom_area(aes(y = bowersock.add.farmland, fill = "eric calculated"), col = "red") +
  scale_fill_manual(name = NULL, values = alpha(c("white", "red", "blue"), 0.5)) +
  theme(legend.position = c(0.15,0.85)) +
  guides(fill = guide_legend(override.aes = list(alpha = 0.5))) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-30"))) +
  xlab("Date") + ylab(expression(paste("Nitrate load (kg-N ", day^-1, ")")))

ggplot(data = massCalcs, aes(x = date)) +
  geom_area(aes(y = desoto_kgNday, fill = "desoto measured"), col = "black") +
  geom_area(aes(y = steve_kgNday, fill = "steve measured"), col = "blue") +
  geom_area(aes(y = bowersock.add.farmland, fill = "eric calculated"), col = "red") +
  geom_area(aes(y = eric_kgNday, fill = "eric measured"), col = "green") +
  scale_fill_manual(name = NULL, values = alpha(c("white", "red", "green","blue"), 0.5)) +
  theme(legend.position = c(0.15,0.85)) +
  guides(fill = guide_legend(override.aes = list(alpha = 0.5))) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-30"))) +
  xlab("Date") + ylab(expression(paste("Nitrate load (kg-N ", day^-1, ")")))




# plot the data
ggplot(data = massBal) +
  geom_line(aes(x = date, y = NitrateLoad.bowersock_kgNday, col = "Bower"), size = 1.2) +
  geom_line(aes(x = date, y = NitrateLoad.desoto_kgNday, col = "Desoto"), size = 1.2) +
  geom_line(aes(x = date, y = NitrateLoad.farmland_kgNday, col = "Farmland"), size = 1.2) +
  geom_line(aes(x = date, y = NitrateLoad.eric_kgNday, col = "Eric"), size = 1.2) +
  geom_line(aes(x = date, y = NitrateLoad.steve_kgNday, col = "Steve"), size = 1.2) +
  xlab("Date") + ylab(expression(paste("Nitrate load (kg-N ", day^-1, ")"))) +
  theme(panel.border = element_rect(color = "black", fill = NA))

ggplot(data = massBal) +
  geom_area(aes(x = date, y = NitrateLoad.desoto_kgNday, fill = "Desoto"), 
            alpha = 0.8, col = "black", size = 1) +
  geom_area(aes(x = date, y = NitrateLoad.bowersock_kgNday, fill = "Bowersock"), 
            alpha = 0.8, col = "black", size = 1) +
  geom_area(aes(x = date, y = NitrateLoad.farmland_kgNday, fill = "Farmland"), 
            alpha = 0.8, col = "black", size = 1) +
  xlab("Date") + ylab(expression(paste("Nitrate load (kg-N ", day^-1, ")"))) +
  theme(panel.border = element_rect(color = "black", fill = NA))
```

```{r}
# load in USGS nutrient csv and reformat, rename parameter codes with parameter names
# change from long format to wide format
# keep only N data
# save as csv and commit

# examine float data
# 

```
