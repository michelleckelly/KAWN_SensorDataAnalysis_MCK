---
title: "KAWN_Sensors_MassBalance"
author: "Michelle Kelly"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup}
library(lubridate)
library(magrittr)
library(dplyr)
library(imputeTS)
library(ggplot2)
library(tidyr)
```

```{r load}
# load from file
loadfromfile <- TRUE

if(loadfromfile == TRUE){
  massBal <- read.csv(file = "./Outputs/NMassBalance.csv")
  massBal$date <- lubridate::ymd(massBal$date)
}

if(loadfromfile == FALSE){
  source("KAWN_Compiler_MassBalanceCSV.R")
  massBal <- read.csv(file = "./Outputs/NMassBalance.csv")
  massBal$date <- lubridate::ymd(massBal$date)
}
```

```{r Plot.NO3Conc}
# Plot of daily average nitrate concentrations through time
# 
# Caption: Average daily nitrate concentration at Upstream (color)
# Discharge, Downstream, and Desoto monitoring sites. Dates span 
# from 1 Feb 2018 to 1 May 2018

ggplot(data = massBal, aes(x = date)) +
  # Upstream (Bowersock)
  geom_line(aes(y = Nitrate.bowersock_mgNL, color = "Upstream")) +
  geom_point(aes(y = Nitrate.bowersock_mgNL, color = "Upstream")) +
  # Discharge (Eric)
  geom_line(aes(y = Nitrate.eric_mgNL, color = "Discharge")) +
  geom_point(aes(y = Nitrate.eric_mgNL, color = "Discharge")) +
  # Desoto
  geom_line(aes(y = Nitrate.desoto_mgNL, color = "Desoto")) +
  geom_point(aes(y = Nitrate.desoto_mgNL, color = "Desoto")) +
  # Downstream (Steve)
  geom_line(aes(y = Nitrate.steve_mgNL, color = "Downstream")) +
  geom_point(aes(y = Nitrate.steve_mgNL, color = "Downstream")) +
  #
  # axis and color scales
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e" ) + 
  scale_color_manual(values = c("Upstream" = "#000000", "Discharge" = "#FF0000", 
                                 "Downstream" = "#23baaf", "Desoto" = "#F2AD00"),
                     breaks = c("Upstream", "Discharge", "Downstream", "Desoto"),
                     name = "Site") +
  scale_shape_manual(values = 21) +
  # axis labels
  xlab("Date") + 
  ylab(expression(NO[3]^{"-"}-N * "  (mg" ~~ L^{-1} * ")"))+
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = c(0.1, 0.79),
        legend.background = element_rect(color = "black"))

ggsave(filename = "./Plots/Nitrate_time.png", device = "png", 
       width = 7.5, height = 4, units = "in")
```

```{r Plot.NO3Load}
# Plot of daily average nitrate load, calculated 
# as daily average nitrate concentration * daily average
# flow

ggplot(data = massBal, aes(x = date)) +
  # Upstream (Bowersock)
  geom_line(aes(y = NitrateLoad.bowersock_kgNday, color = "Upstream")) +
  geom_point(aes(y = NitrateLoad.bowersock_kgNday, color = "Upstream")) +
  # Discharge (Eric)
  geom_line(aes(y = NitrateLoad.eric_kgNday, color = "Discharge")) +
  geom_point(aes(y = NitrateLoad.eric_kgNday, color = "Discharge")) +
  # Desoto
  geom_line(aes(y = NitrateLoad.desoto_kgNday, color = "Desoto")) +
  geom_point(aes(y = NitrateLoad.desoto_kgNday, color = "Desoto")) +
  # Downstream (Steve)
  geom_line(aes(y = Nitrate.steve_mgNL, color = "Downstream")) +
  geom_point(aes(y = Nitrate.steve_mgNL, color = "Downstream")) +
  #
  # axis and color scales
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01")),
               date_breaks = "2 weeks", date_labels = "%b %e" ) + 
  scale_color_manual(values = c("Upstream" = "#000000", "Discharge" = "#FF0000", 
                                 "Downstream" = "#23baaf", "Desoto" = "#F2AD00"),
                     breaks = c("Upstream", "Discharge", "Downstream", "Desoto"),
                     name = "Site") +
  scale_shape_manual(values = 21) +
  # axis labels
  xlab("Date") + 
  ylab(expression(NO[3]^{"-"}-N ~~ "Load  (kg" ~~ day^{-1} * ")"))+
  # plot theme
  theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = c(0.1, 0.79),
        legend.background = element_rect(color = "black"))

ggsave(filename = "./Plots/NitrateLoad_time.png", device = "png", 
       width = 7.5, height = 4, units = "in")
```

```{r ReshapeData}
# select only loading data and
# gather from wide format to long format
Nload <- 
  massBal %>%
  select(date, NitrateLoad.farmland_kgNday:AmmoniaLoad.farmland_kgNday) %>%
  gather(species, load_kgNday, NitrateLoad.farmland_kgNday:AmmoniaLoad.farmland_kgNday)

# add a column for site ID
Nload$site[grepl("bowersock", Nload$species)] <- "Bowersock"
Nload$site[grepl("desoto", Nload$species)] <- "Desoto"
Nload$site[grepl("eric", Nload$species)] <- "Eric"
Nload$site[grepl("steve", Nload$species)] <- "Steve"
Nload$site[grepl("farmland", Nload$species)] <- "Farmland"

# change species column to just species name,
# no other info
Nload$species[grepl("Nitrate", Nload$species)] <- "NO3+NO2"
Nload$species[grepl("Ammonium", Nload$species)] <- "NH4"
Nload$species[grepl("Ammonia", Nload$species)] <- "NH3"
Nload$species[grepl("DIN", Nload$species)] <- "DIN"
```

```{r plot}
theme_set(theme_classic())

Nload[Nload$site %in% c("Eric", "Steve", "Desoto"),]

# upstream
ggplot(data = na.omit(Nload[Nload$site %in% c("Bowersock", "Farmland"),]), 
       aes(x = date)) +
  geom_point(aes(y = load_kgNday, color = species), size = 2) +
  geom_line(aes(y = load_kgNday, color = species)) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  #scale_y_continuous(limits = c(-1000, 4000), labels = scales::scientific) +
  theme(panel.border = element_rect(color = "black", fill = NA)) +
  scale_color_manual(values = c("black", "red", "blue", "green"), 
                     limits = c("NO3+NO2", "NH4", "NH3", "DIN")) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) +
  facet_grid(site ~ .)

ggplot(data = Nload[Nload$site %in% c("Bowersock", "Farmland"),], 
       aes(x = date)) +
  geom_point(aes(y = load_kgNday, color = species), size = 2) +
  geom_line(aes(y = load_kgNday, color = species)) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  #scale_y_continuous(limits = c(-1000, 4000), labels = scales::scientific) +
  theme(panel.border = element_rect(color = "black", fill = NA)) +
  scale_color_manual(values = c("black", "red", "blue", "green"), 
                     limits = c("NO3+NO2", "NH4", "NH3", "DIN")) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) +
  facet_grid(site ~ .)

# downstream
ggplot(data = Nload[Nload$site %in% c("Eric", "Steve", "Desoto"),], 
       aes(x = date)) +
  geom_point(aes(y = load_kgNday, color = species), fill = "white", size = 2, shape = 21) +
  geom_line(aes(y = load_kgNday, color = species), size = 1) +
  theme(panel.border = element_rect(color = "black", fill = NA),
        legend.position = c(0.85, 0.7), legend.background = element_rect(color = "black"),
        legend.title = element_blank()) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 45000), labels = scales::scientific) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) +
  facet_grid(. ~ factor(site, levels = c("Eric", "Steve", "Desoto")))
ggsave("./Plots/Nbal_downstreamfacet.png", width = 6, height = 3, units = "in")
```

```{r plot}
theme_set(theme_classic())

# tiny plots
# bowersock
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.bowersock_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.bowersock_kgNday, col = "NO3 + NO2"), 
             shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniumLoad.bowersock_kgNday),],
            aes(y = AmmoniumLoad.bowersock_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniumLoad.bowersock_kgNday, col = "NH4"), 
             fill = "white", shape = 24, size = 2.5) +
  #geom_line(data = massBal[!is.na(massBal$DINLoad.bowersock_kgNday),],
            #aes(y = DINLoad.bowersock_kgNday, col = "DIN"), size = 1) +
  #geom_point(aes(y = DINLoad.bowersock_kgNday, col = "DIN"), 
              #size = 2.5, shape = 23, fill = "white") +
  scale_y_continuous(limits = c(0, 40000)) +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_color_manual(values = c("black", "red"), 
                     limits = c("NO3 + NO2", "NH4")) +
  theme(legend.position = c(0.65,0.65), legend.title = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),
        legend.background = element_rect(color = "black")) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) + labs(tag = "(a)")
ggsave("./Plots/NBal_bowersock.png", width = 3, height = 2.5, units = "in")
# farmland
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.farmland_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.farmland_kgNday, col = "NO3 + NO2"), shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniaLoad.farmland_kgNday),],
            aes(y = AmmoniaLoad.farmland_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniaLoad.farmland_kgNday, col = "NH4"), shape = 24, size = 1.5, fill = "white") +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 40000)) +
  scale_color_manual(values = c("black", "red"), limits = c("NO3 + NO2", "NH4")) +
  theme(legend.position = "none", panel.border = element_rect(color = "black", fill = NA)) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")"))) + labs(tag = "(b)")
ggsave("./Plots/NBal_farmland.png", width = 3, height = 2.5, units = "in")

# eric
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.eric_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.eric_kgNday, col = "NO3 + NO2"), shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniumLoad.eric_kgNday),],
            aes(y = AmmoniumLoad.eric_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniumLoad.eric_kgNday, col = "NH4"), shape = 24, size = 2.5, fill = "white") +
  #geom_line(data = massBal[!is.na(massBal$DINLoad.eric_kgNday),],
            #aes(y = DINLoad.eric_kgNday, col = "DIN"), size = 1) +
  #geom_point(aes(y = DINLoad.eric_kgNday, col = "DIN"), shape = 23, size = 2.5, fill = "white") +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 45000)) +
  scale_color_manual(values = c("black", "red", "green"), limits = c("NO3 + NO2", "NH4", "DIN")) +
  theme(legend.position = "none", panel.border = element_rect(color = "black", fill = NA)) +
  xlab(NULL) + ylab(expression(paste("N load (kg-N ", day^-1, ")")))
ggsave("./Plots/NBal_eric.png", width = 3, height = 5, units = "in")
# steve
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.steve_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.steve_kgNday, col = "NO3 + NO2"), 
             shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniumLoad.steve_kgNday),],
            aes(y = AmmoniumLoad.steve_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniumLoad.steve_kgNday, col = "NH4"), 
             shape = 24, size = 2.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$DINLoad.steve_kgNday),],
            aes(y = DINLoad.steve_kgNday, col = "DIN"), size = 1) +
  geom_point(aes(y = DINLoad.steve_kgNday, col = "DIN"), 
             shape = 23, size = 2.5, fill = "white") +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 45000), labels = NULL) +
  scale_color_manual(values = c("black", "red", "green"), limits = c("NO3 + NO2", "NH4", "DIN")) +
  theme(legend.position = "none", panel.border = element_rect(color = "black", fill = NA)) +
  xlab(NULL) + ylab(NULL)
ggsave("./Plots/NBal_steve.png", width = 1.75, height = 3, units = "in")
# desoto
ggplot(data = massBal, aes(x = date)) +
  geom_line(aes(y = NitrateLoad.desoto_kgNday, col = "NO3 + NO2")) +
  geom_point(aes(y = NitrateLoad.desoto_kgNday, col = "NO3 + NO2"), 
             shape = 21, size = 1.5, fill = "white") +
  geom_line(data = massBal[!is.na(massBal$AmmoniumLoad.desoto_kgNday),],
            aes(y = AmmoniumLoad.desoto_kgNday, col = "NH4"), size = 1) +
  geom_point(aes(y = AmmoniumLoad.desoto_kgNday, col = "NH4"), 
             shape = 24, size = 2.5, fill = "white") +
  #geom_line(data = massBal[!is.na(massBal$DINLoad.desoto_kgNday),],
            #aes(y = DINLoad.desoto_kgNday, col = "DIN"), size = 1) +
  #geom_point(aes(y = DINLoad.desoto_kgNday, col = "DIN"), shape = 23, size = 2.5, fill = "white") +
  scale_x_date(limits = c(as_date("2018-02-01"), as_date("2018-05-01"))) + 
  scale_y_continuous(limits = c(0, 45000)) +
  scale_color_manual(values = c("black", "red", "blue", "green"), 
                     limits = c("NO3 + NO2", "NH4", "NH3", "DIN")) +
  theme(legend.position = c(0.6,0.75), legend.title = element_blank(), 
        legend.background = element_rect(color = "black"),
        panel.border = element_rect(color = "black", fill = NA)) +
  xlab(NULL) + ylab(NULL)
ggsave("./Plots/NBal_desoto.png", width = 3, height = 5, units = "in")
```
