---
title: 'KAWN: Metabolism Calculations'
author: "Michelle Catherine Kelly"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup}
# grab streamPULSE pipeline tools
#install.packages("devtools")
#library(devtools)
#install_github('streampulse/StreamPULSE', dependencies=TRUE)

# grab latest version of streamMetabolizer
#install.packages("streamMetabolizer", dependencies = TRUE, 
#                repos = c("https://owi.usgs.gov/R", "https://cran.rstudio.com"))

# load packages
library(StreamPULSE)
library(streamMetabolizer)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(tidyr)
```

```{r metabolism.load}
# Load in modeled metabolism data from file
# Skip this block if you haven't run the metabolism model, or if you want 
# to re-compute the model

modelfit.eric <- readRDS("./Outputs/MetabResults_Eric.RData")
modelfit.steve <- readRDS("./Outputs/MetabResults_Steve.RData")
modelfit.desoto <- readRDS("./Outputs/MetabResults_Desoto.RData")
```

```{r metabolism.calculate}
# Model stream metabolism from raw data using StreamPULSE database and 
# streamMetabolizer package

# Unique user token for user michelleckelly, needed to access embargoed data
user_token <- "a1a704245e5fda8ac9b4" 
# Define the desired model type for streamMetabolizer
model_type <-  "bayes"
# Define the desired modeling framework 
model_name <-  "streamMetabolizer"
  
# Eric ----------------------------------------------------------
# Define the site code from the StreamPULSE site list
# Full list of site codes available at: https://data.streampulse.org/sitelist
site_code.eric <- "KS_KANSASREASTLAWRENCE"
# Call to API to request data
eric_data <- request_data(site_code.eric, token = user_token) 
# Format data for modeling
fitdata.eric <- prep_metabolism(eric_data, type = model_type, 
                                model = model_name, rm_flagged = "Bad Data", 
                                fillgaps = "interpolation",
                                estimate_areal_depth = TRUE)
# Fit metabolism model (Run time for this step may be long, depending on your
# computing power. It took 1-2 hrs for me to run this model on a lab laptop)
modelfit.eric <- fit_metabolism(fitdata.eric)
# Save model results
saveRDS(modelfit.eric, file = "./Outputs/MetabResults_Eric.RData") 
write.csv(modelfit.eric$predictions, file = "./Outputs/MetabResults_Eric.csv")
  
# Steve -------------------------------------------------------
site_code.steve <- "KS_KANSASRFALLLEAF"
steve_data <- request_data(site_code.steve, token = user_token) 
fitdata.steve <- prep_metabolism(steve_data, type = model_type, 
                                 model = model_name, rm_flagged = "Bad Data", 
                                 fillgaps = "interpolation",
                                 estimate_areal_depth = TRUE)
modelfit.steve <- fit_metabolism(fitdata.steve)
saveRDS(modelfit.steve, file = "./Outputs/MetabResults_Steve.RData") 
write.csv(modelfit.steve$predictions, file = "./Outputs/MetabResults_Steve.csv")
  
# Desoto ------------------------------------------------------
site_code.desoto <- "KS_KANSASR"
desoto_data <- request_data(site_code.desoto, token = user_token)
fitdata.desoto <- prep_metabolism(desoto_data, type = model_type, 
                                  model = model_name, rm_flagged = "Bad Data", 
                                  fillgaps = "interpolation",
                                  estimate_areal_depth = TRUE)
modelfit.desoto <- fit_metabolism(fitdata.desoto)
saveRDS(modelfit.desoto, file = "./Outputs/MetabResults_Desoto.RData") 
write.csv(modelfit.desoto$predictions, 
          file = "./Outputs/MetabResults_Desoto.csv")

```

```{r DepthCheck}
# Check StreamMetabolizer calculated depth against USGS stream gauging data
# at DeSoto gauge

# Pull calculated depth data from stream metabolism model
eric_calcZ <- modelfit.eric[["fit"]]@data
steve_calcZ <- modelfit.steve[["fit"]]@data
desoto_calcZ <- modelfit.desoto[["fit"]]@data

# Load in gage height data from USGS sensor at Desoto (06892350)
desoto_gage <- read.csv("./Data/USGSDesoto_GageHeight.csv")
# Convert ft to m
desoto_gage$GageHeight_m <- desoto_gage$GageHeight_ft * 0.3048
# Format DateTime
desoto_gage$DateTime <- lubridate::mdy_hm(desoto_gage$DateTime, 
                                          tz = "America/Chicago")
# Take daily mean of Gage heights
desoto_gage <- 
  desoto_gage %>%
  group_by(date = as.Date(DateTime)) %>%
  summarise(GageHeight_m = mean(GageHeight_m))

# Take daily mean of calculated depth
desoto_calcZ <- 
  desoto_calcZ %>%
  group_by(date) %>%
  summarise(calcdepth_m = mean(depth))

# Merge
desoto_calcZ <- dplyr::full_join(desoto_calcZ, desoto_gage, by = "date")
# Plot
ggpubr::ggscatter(desoto_calcZ, x = "GageHeight_m", y = "calcdepth_m", 
                  add = "reg.line", 
                  add.params = list(color = "red", fill = "lightgray"), 
                  conf.int = TRUE) +
  xlab("Gage height, USGS at DeSoto (m)") +
  ylab("Modeled mean depth at S3, StreamMetabolizer (m)") +
  ggpubr::stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")))
# Linear regression
model <- lm(calcdepth_m ~ GageHeight_m, data = desoto_calcZ)
summary(model)
```

```{r NEP.calculate}
# Calculate Net Ecosystem Production (NEP) from metabolism model output

# Arguments
# model_output    dataframe returned by metabolismModeling
# Returns
# dataframe of date, cumulative NEP, cumulative GPP, and cumulative ER for site

NEP_calcs <- function(model_output){
  NEP_data <- data.frame(date = model_output$date,
                         GPP = model_output$GPP,
                         ER = model_output$ER)
  # to perform cumulative sum correctly, any NA values must be set to 0
  NEP_data[is.na(NEP_data)] <- 0
  # take cumulative sum
  NEP_data <- data.frame(date = NEP_data$date,
                         GPP_sum = cumsum(NEP_data$GPP),
                         ER_sum = cumsum(NEP_data$ER))
  # GPP + ER = NEP
  NEP_data$NEP <- rowSums(NEP_data[, c(2,3)])
  return(NEP_data)
}

# NEP calculations
NEP.eric <- NEP_calcs(modelfit.eric$predictions)
NEP.steve <- NEP_calcs(modelfit.steve$predictions)
NEP.desoto <- NEP_calcs(modelfit.desoto$predictions)
```
